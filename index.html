<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Warehouse Management System</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pICvZonb6pj+/U6h8S86YtDj2OmyH9DlK6tm+VQf+U4km/DomZ+ZSSMwL8vqbsOYb7jz0VJo4zQ9ejO9L6LQDw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  
  <style>
    /* Basic Styles */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      background-size: cover;
      background-position: center;
      transition: background-color 0.3s ease;
      font-size: 16px; /* Base font size */
    }
    
    header {
      background-color: rgba(0, 57, 116, 0.9);
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    nav {
      background-color: rgba(0, 75, 153, 0.9);
      color: white;
      padding: 10px 20px;
    }
    
    .nav-menu {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      margin: 0;
      padding: 0;
    }
    
    .nav-menu li {
      margin-right: 20px;
      position: relative;
    }
    
    .nav-menu li a {
      color: white;
      text-decoration: none;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      transition: background-color 0.3s ease, transform 0.3s ease;
      border-radius: 4px;
    }
    
    .nav-menu li a:hover {
      background-color: #002a63;
      transform: translateY(-2px);
    }
    
    /* Dropdown Menu */
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #002a63;
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1;
      top: 40px;
      left: 0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .dropdown-content a {
      color: #333333;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.3s ease;
    }
    
    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }
    
    .dropdown:hover .dropdown-content {
      display: block;
    }
    
    main {
      padding: 20px;
    }
    
    h1, h2, h3 {
      margin: 0 0 15px 0;
      color: #333333;
    }
    
    /* Input Group */
    .input-group {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      position: relative;
    }
    
    .input-group i {
      margin-right: 10px;
      color: #333333;
      position: absolute;
      left: 15px;
      z-index: 2;
    }
    
    input, select, button {
      width: 100%;
      padding: 10px 15px;
      padding-left: 40px; /* Space for icon */
      margin-bottom: 15px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      box-sizing: border-box;
      outline: none;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    
    input:focus, select:focus, button:focus {
      border-color: #003974;
      box-shadow: 0 0 5px rgba(0, 57, 116, 0.5);
    }
    
    button {
      background-color: #003974;
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1em;
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    
    button:hover {
      background-color: #002a63;
      transform: translateY(-2px);
    }
    
    /* Checkbox Container */
    .checkbox-container {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .checkbox-container input {
      margin-right: 10px;
    }
    
    /* Error Messages */
    .error-message {
      color: red;
      margin-top: -10px;
      margin-bottom: 10px;
    }
    
    /* Responsive Tables */
    .table-responsive {
      display: block !important;
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 600px) {
      .table-responsive {
        display: block !important; /* 确保表格始终显示 */
      }
      
      /* 优化表格在移动端的显示 */
      table {
        white-space: nowrap;
        font-size: 14px;
      }
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      background-color: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    th, td {
      text-align: left;
      padding: 12px 15px;
      border-bottom: 1px solid #dddddd;
    }
    
    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 2;
    }
    
    /* Hide on Mobile */
    .hide-on-mobile {
      display: table-cell !important;
    }
    
    @media (max-width: 480px) {
      /* Adjust form inputs and buttons on small screens */
      input, select, button {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 15px;
        font-size: 1em;
      }
      
      .modal-content {
        width: 90%;
        margin: 20% auto;
      }
      
      header, nav, main {
        padding: 10px;
      }
      
      header h2 {
        font-size: 1.2em;
      }
    }
    
    /* Modal Styles */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto; /* 5% from the top and centered */
      padding: 20px;
      border: 1px solid #888;
      width: 50%; /* Could be more or less, depending on screen size */
      border-radius: 8px;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      animation: fadeIn 0.5s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .close {
      color: #aaaaaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
      color: #000;
      text-decoration: none;
      cursor: pointer;
    }
    
    /* Welcome Message */
    #welcome-message {
      margin-right: 15px;
      font-size: 1em;
    }
    
    /* Loading Indicator */
    #loading-indicator {
      display: none; /* Hidden by default */
      position: fixed;
      z-index: 2000;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      color: #003974;
    }
    
    /* Search Bar Styles */
    #search-container {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
    }
    
    #search-input {
      flex: 1;
      padding: 10px 15px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      outline: none;
      transition: all 0.3s ease;
      font-size: 1em;
    }
    
    #search-input:focus {
      border-color: #003974;
      box-shadow: 0 0 5px rgba(0, 57, 116, 0.5);
    }
    
    /* Show/Hide Password Toggle */
    .toggle-password {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #333333;
      transition: color 0.3s ease;
    }
    
    .toggle-password:hover {
      color: #003974;
    }
    
    /* Error State for Select */
    .select-error {
      border-color: red !important;
      box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
    }
    
    /* Remember Me 部分的更新代码 */
    .checkbox-container {
      margin-bottom: 25px;
      display: flex;
      align-items: center;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: 16px;
      height: 16px;
      margin: 0;
      padding: 0;
      cursor: pointer;
      accent-color: #003974;
    }
    
    .checkbox-container label {
      cursor: pointer;
    }
    
    /* Remove card-related styles */
    .cards-container {
      display: none !important; /* 确保卡片永远不显示 */
    }
    
    /* Update table styles to be responsive */
    .table-responsive {
      display: block !important;
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    @media (max-width: 600px) {
      .table-responsive {
        display: block !important; /* 确保表格始终显示 */
      }
      
      /* 优化表格在移动端的显示 */
      table {
        white-space: nowrap;
        font-size: 14px;
      }
    }

    .delete-button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 5px;
      transition: background-color 0.3s ease;
    }

    .delete-button:hover {
      background-color: #c82333;
    }

    #inventory-search-container {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    #inventory-search-container .input-group {
      flex: 1;
      position: relative;
    }

    #inventory-search-container input,
    #inventory-search-container select {
      width: 100%;
      padding: 10px 15px;
      padding-left: 40px;
      border: 1px solid #cccccc;
      border-radius: 25px;
      outline: none;
      transition: all 0.3s ease;
      font-size: 1em;
      background-color: white;
    }

    #inventory-search-container i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #333333;
    }

    #inventory-search-container input:focus,
    #inventory-search-container select:focus {
      border-color: #003974;
      box-shadow: 0 0 5px rgba(0, 57, 116, 0.5);
    }

    /* 确保下拉框样式与输入框一致 */
    #inventory-category-filter {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    /* 添加下拉箭头 */
    .input-group:has(select)::after {
      content: '\f107';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #333333;
    }

    @media (max-width: 600px) {
      #inventory-search-container {
        flex-direction: column;
        gap: 10px;
      }
    }

    /* Add these styles to your existing CSS */
    #online-records-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      background-color: white;
    }

    #online-records-table th,
    #online-records-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    #online-records-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }

    #online-records-table tr:hover {
      background-color: #f9f9f9;
    }

    /* 在现有的 CSS 中添加以下样式 */

    /* Transaction Records Table Styles */
    #transaction-records-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-bottom: 20px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-radius: 8px;
    }

    #transaction-records-table th {
      background: #f8f9fa;
      padding: 12px 15px;
      font-weight: 600;
      text-align: left;
      border-bottom: 2px solid #dee2e6;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #transaction-records-table td {
      padding: 12px 15px;
      border-bottom: 1px solid #dee2e6;
      vertical-align: middle;
    }

    /* 交替行颜色 */
    #transaction-records-table tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #transaction-records-table tbody tr:hover {
      background-color: #f2f4f6;
    }

    /* 数量样式 */
    .quantity-in {
      color: #28a745;
      font-weight: 500;
    }

    .quantity-out {
      color: #dc3545;
      font-weight: 500;
    }

    /* 类型标签样式 */
    .transaction-type {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      margin-right: 8px;
    }

    .type-in {
      background-color: #d4edda;
      color: #155724;
    }

    .type-out {
      background-color: #f8d7da;
      color: #721c24;
    }

    /* 统计信息面板 */
    .transaction-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 1000px;
      margin-left: auto;
      margin-right: auto;
    }

    .stat-card {
      padding: 15px;
      border-radius: 6px;
      background: #f8f9fa;
    }

    .stat-title {
      font-size: 1.1em;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #dee2e6;
      font-weight: 600;
    }

    .stat-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .comment-stat {
      padding: 8px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .comment-name {
      font-weight: 500;
      color: #495057;
      margin-bottom: 4px;
    }

    .comment-quantity {
      color: #666;
      font-size: 0.9em;
    }

    .no-data {
      color: #6c757d;
      font-style: italic;
      text-align: center;
      padding: 10px;
    }
    
    /* 图片预览容器样式 */
    #image-preview-container {
        max-width: 200px;
        margin: 10px 0;
    }
    
    #image-preview-container img {
        max-width: 100%;
        height: auto;
        border-radius: 4px;
    }
    
    .delete-image-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .delete-image-button:hover {
        background: rgba(255, 0, 0, 0.9);
    }
    
    .inventory-image {
        max-width: 50px;
        height: auto;
        border-radius: 4px;
        cursor: pointer;
    }
    
    /* 图片放大模态框样式 */
    .image-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
    }
    
    .image-modal-content {
        margin: auto;
        display: block;
        max-width: 90%;
        max-height: 90%;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
  </style>

  <!-- 在 <head> 标签内添加这些 meta 标签 -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
</head>
<body>
  <!-- Loading Indicator -->
  <div id="loading-indicator">
    <i class="fas fa-spinner fa-spin fa-3x"></i>
  </div>

  <!-- Authentication Container -->
  <div id="auth-container">
    <!-- Login Form -->
    <div id="login-form" style="max-width: 400px; margin: 50px auto; padding: 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <!-- Logo and Title -->
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #003974; font-size: 2.5em; margin-bottom: 10px;">
          <i class="fas fa-box-open" style="color: #003974;"></i> SmartProfits
        </h1>
        <p style="color: #666; font-size: 1.1em;">Stock Management System</p>
      </div>

      <!-- Login Form -->
      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-envelope" style="color: #003974;"></i>
        <input type="email" id="login-email" placeholder="Enter Email" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-lock" style="color: #003974;"></i>
        <input type="password" id="login-password" placeholder="Enter Password" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
        <i class="fas fa-eye toggle-password" id="toggle-password" style="color: #003974; cursor: pointer;"></i>
      </div>

      <!-- Remember Me -->
      <div class="checkbox-container" style="margin-bottom: 25px; display: flex; align-items: center;">
        <div style="display: flex; align-items: center;">
          <input type="checkbox" id="remember-me" style="margin: 0; width: auto; height: auto;">
          <label for="remember-me" style="color: #666; margin-left: 8px;">Remember Me</label>
        </div>
        <div style="margin-left: auto;">
          <a href="#" id="forgot-password" style="color: #003974; text-decoration: none; font-weight: 500;">Forgot Password?</a>
        </div>
      </div>

      <!-- Login Button -->
      <button id="login-button" style="background: linear-gradient(135deg, #003974, #002a63); margin-bottom: 20px; height: 50px; font-size: 1.1em; letter-spacing: 1px;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>

      <!-- Links -->
      <div style="text-align: center; margin-top: 20px;">
        <p style="color: #666;">
          Don't have an account? 
          <a href="#" id="show-register" style="color: #003974; text-decoration: none; font-weight: 500;">Register</a>
        </p>
      </div>

      <!-- Error Message -->
      <p id="login-error" class="error-message" style="text-align: center; color: #dc3545; margin-top: 15px;"></p>
    </div>
    
    <!-- Register Form -->
    <div id="register-form" style="display: none; max-width: 400px; margin: 50px auto; padding: 40px; background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1);">
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: #003974; font-size: 2.5em; margin-bottom: 10px;">
          <i class="fas fa-user-plus" style="color: #003974;"></i> Register
        </h1>
        <p style="color: #666; font-size: 1.1em;">Create your account</p>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-user" style="color: #003974;"></i>
        <input 
          type="text" 
          id="register-name" 
          placeholder="Enter Name" 
          maxlength="12" 
          style="background: #f8f9fa; border: 2px solid #e9ecef;" 
          required
        >
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-envelope" style="color: #003974;"></i>
        <input type="email" id="register-email" placeholder="Enter Email" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <div class="input-group" style="margin-bottom: 25px;">
        <i class="fas fa-lock" style="color: #003974;"></i>
        <input type="password" id="register-password" placeholder="Enter Password" style="background: #f8f9fa; border: 2px solid #e9ecef;" required>
      </div>

      <button id="register-button" style="background: linear-gradient(135deg, #003974, #002a63); margin-bottom: 20px; height: 50px; font-size: 1.1em; letter-spacing: 1px;">
        <i class="fas fa-user-plus"></i> Register
      </button>

      <div style="text-align: center;">
        <p style="color: #666;">
          Already have an account? 
          <a href="#" id="show-login" style="color: #003974; text-decoration: none; font-weight: 500;">Login</a>
        </p>
      </div>

      <p id="register-error" class="error-message" style="text-align: center; color: #dc3545; margin-top: 15px;"></p>
    </div>
  </div>

  <!-- Main Application Container -->
  <div id="app-container" style="display: none;">
    <header>
      <h1 style="color: ghostwhite;">SmartProfits Stock System</h1>
      <div id="user-info">
        <span id="welcome-message"></span>
        <button id="logout-button"><i class="fas fa-sign-out-alt"></i> Logout</button>
      </div>
    </header>
    
    <nav>
      <ul class="nav-menu" id="nav-menu">
        <li><a href="#" id="nav-inventory"><i class="fas fa-boxes"></i> Inventory List</a></li>
        <!-- Stock In Dropdown Menu -->
        <li class="dropdown">
          <a href="#"><i class="fas fa-download"></i> Stock In</a>
          <div class="dropdown-content">
            <a href="#" id="nav-stock-in-office">Office</a>
            <a href="#" id="nav-stock-in-kepayan-seafood">Kepayan - Seafood</a>
            <a href="#" id="nav-stock-in-kepayan-packaged">Kepayan - Packaged Food</a>
          </div>
        </li>
        <!-- Stock Out -->
        <li><a href="#" id="nav-stock-out"><i class="fas fa-box-open"></i> Stock Out</a></li>
        <!-- Transaction Records -->
        <li><a href="#" id="nav-transaction-records"><i class="fas fa-exchange-alt"></i> Transaction Records</a></li>
        <!-- Online Record for sadmin -->
        <li><a href="#" id="nav-online-records"><i class="fas fa-user-clock"></i> Online Record</a></li>
      </ul>
    </nav>
    
    <main>
      <!-- Inventory List Section -->
      <section id="inventory-list-section">
        <h3>Inventory List</h3>
        
        <!-- Search Bar -->
        <div id="inventory-search-container">
          <div class="input-group">
            <i class="fas fa-search"></i>
            <input type="text" id="search-input" placeholder="Search Products">
          </div>
          <div class="input-group">
            <i class="fas fa-filter"></i>
            <select id="inventory-category-filter">
              <option value="all">All Categories</option>
              <option value="Office">Office</option>
              <option value="Seafood">Seafood</option>
              <option value="Ban Heang">Ban Heang</option>
              <option value="Hop Hup">Hop Hup</option>
              <option value="Tenom Kopi">Tenom Kopi</option>
              <option value="Amplang">Amplang</option>
              <option value="Chocolate">Chocolate</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        
        <!-- Responsive Table -->
        <div class="table-responsive">
          <table id="inventory-table" style="border-collapse: collapse;">
            <thead>
              <tr style="height: 40px;">
                <th>Product Name</th>
                <th style="width: 100px;">Image</th>
                <th class="hide-on-mobile sortable" data-sort="category">Category ↕</th>
                <th>Quantity</th>
                <th class="hide-on-mobile">Unit</th>
                <th class="hide-on-mobile sortable" data-sort="expiry">Expiry Date ↕</th>
                <th class="hide-on-mobile">Location</th>
                <th class="hide-on-mobile">Last Modified Time</th>
                <th class="hide-on-mobile">Modified By</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <!-- Items will be dynamically populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Card Layout -->
        <div id="inventory-cards" class="cards-container" style="display: none;">
          <!-- Inventory Item Cards Will Be Dynamically Populated -->
        </div>
        <p id="inventory-message"></p>
      </section>
      
      <!-- Stock In Section - Office -->
      <section id="stock-in-office-section" style="display: none;">
        <h3>Stock In - Office</h3>
        <label for="stock-in-office-name">Product Name</label>
        <input type="text" id="stock-in-office-name" placeholder="Product Name" required>
        
        <input type="hidden" id="stock-in-office-category" value="Office">
        
        <label for="stock-in-office-quantity">Quantity</label>
        <input type="number" id="stock-in-office-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-office-unit">Unit</label>
        <input type="text" id="stock-in-office-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-office-expired-date">Expiry Date (Optional)</label>
        <input type="text" id="stock-in-office-expired-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}">
        
        <label for="stock-in-office-location">Location</label>
        <select id="stock-in-office-location" required>
            <option value="office">Office</option>
        </select>
        
        <button id="stock-in-office-button"><i class="fas fa-download"></i> Add Stock In - Office</button>
        <p id="stock-in-office-error" class="error-message"></p>
      </section>
      
      <!-- Stock In Section - Kepayan - Seafood -->
      <section id="stock-in-kepayan-seafood-section" style="display: none;">
        <h3>Stock In - Kepayan - Seafood</h3>
        <label for="stock-in-kepayan-seafood-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-seafood-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-seafood-category">Category</label>
        <select id="stock-in-kepayan-seafood-category" required>
            <option value="">Select Category</option>
            <option value="Seafood">Seafood</option>
        </select>
        
        <label for="stock-in-kepayan-seafood-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-seafood-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-seafood-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-seafood-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-seafood-expired-date">Expiry Date (Optional)</label>
        <input type="text" id="stock-in-kepayan-seafood-expired-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}">
        
        <label for="stock-in-kepayan-seafood-location">Location</label>
        <select id="stock-in-kepayan-seafood-location" required>
            <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-seafood-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Seafood</button>
        <p id="stock-in-kepayan-seafood-error" class="error-message"></p>
      </section>
      
      <!-- Stock In Section - Kepayan - Packaged Food -->
      <section id="stock-in-kepayan-packaged-section" style="display: none;">
        <h3>Stock In - Kepayan - Packaged Food</h3>
        <label for="stock-in-kepayan-packaged-name">Product Name</label>
        <input type="text" id="stock-in-kepayan-packaged-name" placeholder="Product Name" required>
        
        <label for="stock-in-kepayan-packaged-category">Category</label>
        <select id="stock-in-kepayan-packaged-category" required>
            <option value="">Select Category</option>
            <option value="Ban Heang">Ban Heang</option>
            <option value="Hop Hup">Hop Hup</option>
            <option value="Tenom Kopi">Tenom Kopi</option>
            <option value="Amplang">Amplang</option>
            <option value="Chocolate">Chocolate</option>
            <option value="Other">Other</option>
        </select>
        
        <label for="stock-in-kepayan-packaged-quantity">Quantity</label>
        <input type="number" id="stock-in-kepayan-packaged-quantity" placeholder="Quantity" required>
        
        <label for="stock-in-kepayan-packaged-unit">Unit</label>
        <input type="text" id="stock-in-kepayan-packaged-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="stock-in-kepayan-packaged-expired-date">Expiry Date (Optional)</label>
        <input type="text" id="stock-in-kepayan-packaged-expired-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}">
        
        <label for="stock-in-kepayan-packaged-location">Location</label>
        <select id="stock-in-kepayan-packaged-location" required>
            <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="stock-in-kepayan-packaged-button"><i class="fas fa-download"></i> Add Stock In - Kepayan - Packaged Food</button>
        <p id="stock-in-kepayan-packaged-error" class="error-message"></p>
      </section>
      
      <!-- Transaction Records Section -->
      <section id="transaction-records-section" style="display: none;">
        <h3>Transaction Records</h3>
        
        <!-- Add Date Filter -->
        <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
          <select id="transaction-date-filter" style="width: auto;">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="last7days">Last 7 Days</option>
            <option value="last30days">Last 30 Days</option>
            <option value="custom">Custom Date</option>
            <option value="all">All Records</option>
          </select>
          
          <input 
            type="date" 
            id="transaction-custom-date" 
            style="width: auto; display: none;"
          >
        </div>
        
        <!-- Rest of the existing transaction records table -->
        <div class="table-responsive">
          <table id="transaction-records-table">
            <thead>
              <tr>
                <th>Product Name</th>
                <th class="hide-on-mobile">Category</th>
                <th>Quantity</th>
                <th class="hide-on-mobile">Unit</th>
                <th>Transaction Time</th> <!-- Added Stock Out Time -->
                <th>Modified By</th>
                <th>Comment</th>
              </tr>
            </thead>
            <tbody>
              <!-- Transaction Records Will Be Dynamically Populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Mobile Card Layout for Transaction Records (Displays All Data) -->
        <div id="transaction-records-cards" class="cards-container" style="display: none;">
          <!-- Transaction Records Cards Will Be Dynamically Populated -->
        </div>
        <p id="transaction-records-message"></p>
      </section>
      
      <!-- Stock Out Section -->
      <section id="stock-out-section" style="display: none;">
        <h3>Stock Out</h3>
        
        <!-- Search and Filter -->
        <div id="stock-out-search-container">
          <input type="text" id="stock-out-search" placeholder="Search Products">
          <select id="stock-out-location-filter">
            <option value="all">All Locations</option>
            <option value="office">Office</option>
            <option value="kepayan">Kepayan</option>
          </select>
          <!-- Add category filter -->
          <select id="stock-out-category-filter">
            <option value="all">All Categories</option>
            <option value="Office">Office</option>
            <option value="Seafood">Seafood</option>
            <option value="Ban Heang">Ban Heang</option>
            <option value="Hop Hup">Hop Hup</option>
            <option value="Tenom Kopi">Tenom Kopi</option>
            <option value="Amplang">Amplang</option>
            <option value="Chocolate">Chocolate</option>
            <option value="Other">Other</option>
          </select>
        </div>
        
        <!-- Table for selecting items -->
        <div class="table-responsive">
          <table id="stock-out-table">
            <thead>
              <tr>
                <th><input type="checkbox" id="select-all-items"></th>
                <th>Product Name</th>
                <th>Category</th>
                <th>Available Quantity</th>
                <th>Unit</th>
                <th>Location</th>
                <th>Stock Out Quantity</th>
              </tr>
            </thead>
            <tbody>
              <!-- Items will be dynamically populated -->
            </tbody>
          </table>
        </div>
        
        <!-- Batch Stock Out Form -->
        <div id="batch-stock-out-form">
          <label for="stock-out-comment">Comment:</label>
          <select id="stock-out-comment" required>
            <option value="" disabled selected>Select Comment</option>
            <option value="Tamoi">Tamoi</option>
            <option value="KTSP">KTSP</option>
            <option value="Ole-Ole(DALAM)">Ole-Ole(DALAM)</option>
            <option value="Ole-Ole(Luar)">Ole-Ole(Luar)</option>
            <option value="TOM">TOM</option>
            <option value="JKL">JKL</option>
            <option value="Wrapping">Wrapping</option>
            <option value="Left Luggage">Left Luggage</option>
            <option value="Wisma">Wisma</option>
            <option value="Datuk">Datuk</option>
            <option value="Kepayan">Kepayan</option>
          </select>

          <button id="batch-stock-out-button" disabled>
            <i class="fas fa-box-open"></i> Process Stock Out
          </button>
          <p id="batch-stock-out-error" class="error-message"></p>
        </div>
      </section>

      <!-- Online Records Section -->
      <section id="online-records-section" style="display: none;">
        <h3>Online Record</h3>
        <div class="table-responsive">
          <table id="online-records-table" class="table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Login Time</th>
                <th>Last Active</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="online-records-table-body">
              <!-- Records will be dynamically populated -->
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <!-- Edit Inventory Item Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Edit Inventory Item</h3>
        
        <label for="edit-item-name">Product Name</label>
        <input type="text" id="edit-item-name" placeholder="Product Name" required>
        
        <!-- 图片上传部分 - 放在产品名称之后 -->
        <div id="image-upload-section" style="display: none; margin: 15px 0;">
            <label>Product Image</label>
            <div style="display: flex; align-items: center; gap: 10px;">
                <input type="file" id="edit-item-image" accept="image/*" style="flex: 1;">
                <button id="upload-image-button" style="width: auto; padding: 8px 15px;">
                    <i class="fas fa-upload"></i> Upload
                </button>
            </div>
            <div id="image-preview-container" style="margin-top: 10px; position: relative;">
                <!-- 预览图片将在这里显示 -->
            </div>
            <p id="image-upload-error" class="error-message"></p>
        </div>
        
        <label for="edit-item-category">Category</label>
        <select id="edit-item-category" required>
            <option value="">Select Category</option>
            <option value="Office">Office</option>
            <option value="Seafood">Seafood</option>
            <option value="Ban Heang">Ban Heang</option>
            <option value="Hop Hup">Hop Hup</option>
            <option value="Tenom Kopi">Tenom Kopi</option>
            <option value="Amplang">Amplang</option>
            <option value="Chocolate">Chocolate</option>
            <option value="Other">Other</option>
        </select>
        
        <label for="edit-item-quantity">Quantity</label>
        <input type="number" id="edit-item-quantity" placeholder="Quantity" required>
        
        <label for="edit-item-unit">Unit</label>
        <input type="text" id="edit-item-unit" placeholder="Unit (e.g., pieces, boxes, kg)" required>
        
        <label for="edit-item-expired-date">Expiry Date (Optional)</label>
        <input type="text" id="edit-item-expired-date" placeholder="DD-MM-YYYY" pattern="\d{2}-\d{2}-\d{4}">
        
        <label for="edit-item-location">Location</label>
        <select id="edit-item-location" required>
            <option value="">Select Location</option>
            <option value="office">Office</option>
            <option value="kepayan">Kepayan</option>
        </select>
        
        <button id="save-edit-button">Save Changes</button>
        <p id="edit-item-error" class="error-message"></p>
    </div>
  </div>

  <!-- Stock Out Modal -->
  <div id="stock-out-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Stock Out</h3>
      
      <label for="stock-out-quantity">Quantity to Stock Out</label>
      <input type="number" id="stock-out-quantity" placeholder="Quantity" required>
      
      <label for="stock-out-comment">Comment</label>
      <select id="stock-out-comment" required>
        <option value="" disabled selected>Select Comment</option>
        <option value="Tamoi">Tamoi</option>
        <option value="KTSP">KTSP</option>
        <option value="Ole-Ole(DALAM)">Ole-Ole(DALAM)</option>
        <option value="Ole-Ole(Luar)">Ole-Ole(Luar)</option>
        <option value="TOM">TOM</option>
        <option value="JKL">JKL</option>
        <option value="Wrapping">Wrapping</option>
        <option value="Left Luggage">Left Luggage</option>
        <option value="Wisma">Wisma</option>
        <option value="Datuk">Datuk</option>
        <option value="Kepayan">Kepayan</option>
      </select>
      
      <button id="confirm-stock-out-button"><i class="fas fa-check"></i> Confirm Stock Out</button>
      <p id="stock-out-error" class="error-message"></p>
    </div>
  </div>

  <!-- 添加图片查看模态框 -->
  <div id="image-view-modal" class="image-modal">
    <span class="close" style="position: absolute; right: 20px; top: 20px; color: white; font-size: 30px; cursor: pointer;">&times;</span>
    <img class="image-modal-content" id="full-size-image">
  </div>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDAK5KVv9oln2qS5EfNzox1snM19wa83-o",
      authDomain: "smart-profits-stock.firebaseapp.com",
      databaseURL: "https://smart-profits-stock-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smart-profits-stock",
      storageBucket: "smart-profits-stock.firebasestorage.app",
      messagingSenderId: "1029424292465",
      appId: "1:1029424292465:web:6de46925db8818d462b1d0",
      measurementId: "G-R0K4Q7JTGE"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Get Page Elements
    const authContainer = document.getElementById('auth-container');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const loginButton = document.getElementById('login-button');
    const registerButton = document.getElementById('register-button');
    const loginError = document.getElementById('login-error');
    const registerError = document.getElementById('register-error');

    const appContainer = document.getElementById('app-container');
    const logoutButton = document.getElementById('logout-button');
    const navInventory = document.getElementById('nav-inventory');
    const navStockInOffice = document.getElementById('nav-stock-in-office');
    const navStockInKepayanSeafood = document.getElementById('nav-stock-in-kepayan-seafood');
    const navStockInKepayanPackaged = document.getElementById('nav-stock-in-kepayan-packaged');
    const navTransactionRecords = document.getElementById('nav-transaction-records'); // Added
    const navStockOut = document.getElementById('nav-stock-out');
    const stockOutSection = document.getElementById('stock-out-section');
    const stockOutTable = document.getElementById('stock-out-table');
    const selectAllItems = document.getElementById('select-all-items');
    const batchStockOutButton = document.getElementById('batch-stock-out-button');
    const stockOutSearch = document.getElementById('stock-out-search');
    const stockOutLocationFilter = document.getElementById('stock-out-location-filter');

    const inventoryListSection = document.getElementById('inventory-list-section');
    const stockInOfficeSection = document.getElementById('stock-in-office-section');
    const stockInKepayanSeafoodSection = document.getElementById('stock-in-kepayan-seafood-section');
    const stockInKepayanPackagedSection = document.getElementById('stock-in-kepayan-packaged-section');
    const transactionRecordsSection = document.getElementById('transaction-records-section'); // Added

    // Stock In Buttons
    const stockInOfficeButton = document.getElementById('stock-in-office-button');
    const stockInKepayanSeafoodButton = document.getElementById('stock-in-kepayan-seafood-button');
    const stockInKepayanPackagedButton = document.getElementById('stock-in-kepayan-packaged-button');

    // Stock In Input Fields
    const stockInOfficeNameInput = document.getElementById('stock-in-office-name');
    const stockInOfficeQuantityInput = document.getElementById('stock-in-office-quantity');
    const stockInOfficeUnitInput = document.getElementById('stock-in-office-unit');
    const stockInOfficeExpiredDateInput = document.getElementById('stock-in-office-expired-date');
    const stockInOfficeLocationSelect = document.getElementById('stock-in-office-location');
    const stockInOfficeError = document.getElementById('stock-in-office-error');

    const stockInKepayanSeafoodNameInput = document.getElementById('stock-in-kepayan-seafood-name');
    const stockInKepayanSeafoodCategorySelect = document.getElementById('stock-in-kepayan-seafood-category');
    const stockInKepayanSeafoodQuantityInput = document.getElementById('stock-in-kepayan-seafood-quantity');
    const stockInKepayanSeafoodUnitInput = document.getElementById('stock-in-kepayan-seafood-unit');
    const stockInKepayanSeafoodExpiredDateInput = document.getElementById('stock-in-kepayan-seafood-expired-date');
    const stockInKepayanSeafoodLocationSelect = document.getElementById('stock-in-kepayan-seafood-location');
    const stockInKepayanSeafoodError = document.getElementById('stock-in-kepayan-seafood-error');

    const stockInKepayanPackagedNameInput = document.getElementById('stock-in-kepayan-packaged-name');
    const stockInKepayanPackagedCategorySelect = document.getElementById('stock-in-kepayan-packaged-category');
    const stockInKepayanPackagedQuantityInput = document.getElementById('stock-in-kepayan-packaged-quantity');
    const stockInKepayanPackagedUnitInput = document.getElementById('stock-in-kepayan-packaged-unit');
    const stockInKepayanPackagedExpiredDateInput = document.getElementById('stock-in-kepayan-packaged-expired-date');
    const stockInKepayanPackagedLocationSelect = document.getElementById('stock-in-kepayan-packaged-location');
    const stockInKepayanPackagedError = document.getElementById('stock-in-kepayan-packaged-error');

    const inventoryTableBody = document.querySelector('#inventory-table tbody');
    const inventoryMessage = document.getElementById('inventory-message');
    const inventoryCardsContainer = document.getElementById('inventory-cards');

    const transactionRecordsTableBody = document.querySelector('#transaction-records-table tbody'); // Added
    const transactionRecordsMessage = document.getElementById('transaction-records-message'); // Added

    const editModal = document.getElementById('edit-modal');
    const closeModalSpan = editModal.querySelector('.close');
    const editItemTypeSelect = document.getElementById('edit-item-type'); // Added
    const editItemNameInput = document.getElementById('edit-item-name');
    const editItemCategorySelect = document.getElementById('edit-item-category');
    const editItemQuantityInput = document.getElementById('edit-item-quantity');
    const editItemUnitInput = document.getElementById('edit-item-unit');
    const editItemExpiredDateInput = document.getElementById('edit-item-expired-date');
    const editItemLocationSelect = document.getElementById('edit-item-location');
    const saveEditButton = document.getElementById('save-edit-button');
    const editItemError = document.getElementById('edit-item-error');

    const stockOutModal = document.getElementById('stock-out-modal'); // Added
    const closeStockOutModalSpan = stockOutModal.querySelector('.close'); // Added
    const confirmStockOutButton = document.getElementById('confirm-stock-out-button'); // Added
    const stockOutQuantityInput = document.getElementById('stock-out-quantity'); // Added
    const stockOutCommentInput = document.getElementById('stock-out-comment'); // Changed to select
    const stockOutError = document.getElementById('stock-out-error'); // Added

    const loadingIndicator = document.getElementById('loading-indicator');

    // User Info Display Element
    const welcomeMessage = document.getElementById('welcome-message');

    let currentEditItemId = null; // Current Editing Inventory Item ID
    let currentStockOutItemId = null; // Current Stock Out Inventory Item ID // Added
    let userRole = null; // Current User Role

    /**
     * Formats an ISO 8601 date string to "dd-mm-yyyy (hh.mmam/pm)"
     * @param {string} isoString - The ISO 8601 date string.
     * @returns {string} - The formatted date string.
     */
    function formatDateTime(isoString) {
        const date = new Date(isoString);
        if (isNaN(date)) return 'Invalid Date';

        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are zero-based
        const year = date.getFullYear();

        let hours = date.getHours();
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const ampm = hours >= 12 ? 'pm' : 'am';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        const formattedTime = `${String(hours).padStart(2, '0')}.${minutes}${ampm}`;

        return `${day}-${month}-${year} (${formattedTime})`;
    }

    // Add new helper function to convert ISO to DD-MM-YYYY
    function isoToFormattedDate(isoString) {
        if (!isoString) return '';
        const date = new Date(isoString);
        if (isNaN(date)) return '';
        
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        
        return `${day}-${month}-${year}`;
    }

    // Add new helper function to convert DD-MM-YYYY to ISO
    function formattedDateToIso(dateString) {
        if (!dateString) return '';
        const [day, month, year] = dateString.split('-');
        return `${year}-${month}-${day}`;
    }

    // Get Inventory Paths Based on User Role
    function getInventoryPaths() {
      let paths = [];
      if (userRole === 'admin' || userRole === 'adminv' || userRole === 'sadmin') { // Added 'sadmin'
        paths = ['inventory/office', 'inventory/kepayan'];
      } else if (userRole === 'admino') {
        paths = ['inventory/office'];
      } else if (userRole === 'admink') {
        paths = ['inventory/kepayan'];
      } else {
        // Regular users might only have view permissions
        paths = ['inventory'];
      }
      return paths;
    }

    // Show/Hide Register Form
    showRegisterLink.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.style.display = 'none';
      registerForm.style.display = 'block';
    });

    showLoginLink.addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.style.display = 'none';
      loginForm.style.display = 'block';
    });

    // Register Functionality
    registerButton.addEventListener('click', (e) => {
      e.preventDefault();
      const name = document.getElementById('register-name').value.trim();
      const email = document.getElementById('register-email').value.trim();
      const password = document.getElementById('register-password').value.trim();

      if (name === '' || email === '' || password === '') {
        registerError.textContent = 'Please fill in all fields.';
        return;
      }

      showLoading();

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // Registration successful, set display name
          return userCredential.user.updateProfile({
            displayName: name
          });
        })
        .then(() => {
          // Save user info to database with default role "user"
          const user = auth.currentUser;
          if (user) {
            db.ref('users/' + user.uid).set({
              name: user.displayName,
              email: user.email,
              role: 'user' // Default role is "user"
            });
          }
          registerError.textContent = '';
          registerForm.reset();
        })
        .catch((error) => {
          console.error('Registration Error:', error);
          registerError.textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Login Functionality (Including "Remember Me")
    loginButton.addEventListener('click', () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const rememberMe = document.getElementById('remember-me').checked;

      showLoading();
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          const user = userCredential.user;
          
          // 记录用户登录信息到 onlineRecords
          db.ref(`onlineRecords/${user.uid}`).set({
            userName: user.displayName || 'Unknown',
            email: user.email,
            loginTime: new Date().toISOString(),
            isOnline: true,
            lastActive: new Date().toISOString()
          });

          // 设置会话持久性为 SESSION，这样浏览器关闭后就会清除登录状态
          auth.setPersistence(firebase.auth.Auth.Persistence.SESSION)
            .then(() => {
              if (rememberMe) {
                // 只记住邮箱，不记住登录状态
                localStorage.setItem('rememberedEmail', email);
              } else {
                localStorage.removeItem('rememberedEmail');
              }
            });
        })
        .catch((error) => {
          document.getElementById('login-error').textContent = error.message;
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Listen for Authentication State Changes
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is logged in, get user role
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        document.body.classList.add('logged-in'); // Add class to change background
        getUserRole(user.uid);

        // Display welcome message
        const displayName = user.displayName || 'User';
        welcomeMessage.textContent = `Welcome, ${displayName} (${userRole ? userRole : 'Loading...'})`;

        console.log('User logged in:', user.email);
        db.ref(`users/${user.uid}/role`).once('value')
            .then((snapshot) => {
                const role = snapshot.val();
                console.log('Current user role:', role);
            });
      } else {
        // User is not logged in, show login/register
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
        document.body.classList.remove('logged-in'); // Remove class to restore background
        inventoryTableBody.innerHTML = '';
        inventoryCardsContainer.innerHTML = '';
        inventoryMessage.textContent = '';
        transactionRecordsTableBody.innerHTML = ''; // Clear transaction records table
        transactionRecordsMessage.textContent = '';
        welcomeMessage.textContent = '';
      }
    });

    // Get User Role from Database
    function getUserRole(uid) {
      db.ref(`users/${uid}/role`).once('value')
        .then((snapshot) => {
          userRole = snapshot.val();
          console.log('User role:', userRole); // 添加这行来调试
          
          // 在这里添加显示/隐藏图片上传部分的逻辑
          const imageUploadSection = document.getElementById('image-upload-section');
          if (imageUploadSection) {
            imageUploadSection.style.display = userRole === 'sadmin' ? 'block' : 'none';
          }
          
          adjustUIBasedOnRole();
          loadInventoryForRole(); // Load inventory based on role
        })
        .then(() => {
          // Update welcome message
          const user = auth.currentUser;
          const displayName = user.displayName || 'User';
          welcomeMessage.textContent = `Welcome, ${displayName} (${userRole})`;
        })
        .catch((error) => {
          console.error('Failed to get user role:', error);
        });
    }

    // Adjust UI Based on User Role
    function adjustUIBasedOnRole() {
      // Reset all navigation items' display
      document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
        element.style.display = 'block';
      });
      
      // Show/hide online records nav item based on role
      const onlineRecordsNav = document.getElementById('nav-online-records');
      if (onlineRecordsNav) {
        onlineRecordsNav.parentElement.style.display = userRole === 'sadmin' ? 'block' : 'none';
      }

      // Hide functionalities based on role
      switch(userRole) {
        case 'sadmin':
          // Sadmin: Access to all functionalities, no need to hide anything
          break;
        case 'admin':
          // Admin: Hide online records
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
          break;
        case 'adminv':
          // Adminv: Can only view inventory, hide stock in, stock out, and online records
          document.querySelectorAll('.nav-menu .dropdown').forEach(dropdown => {
            dropdown.style.display = 'none';
          });
          document.getElementById('nav-stock-out').style.display = 'none';
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
          break;
        case 'admino':
          // Admino: Can only manage office inventory
          document.getElementById('nav-stock-in-kepayan-seafood').style.display = 'none';
          document.getElementById('nav-stock-in-kepayan-packaged').style.display = 'none';
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
          break;
        case 'admink':
          // Admink: Can only manage kepayan inventory
          document.getElementById('nav-stock-in-office').style.display = 'none';
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
          break;
        case 'user':
          // User: Regular user, hide all functionalities including inventory list
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
          break;
        default:
          // Undefined role, hide all functionalities
          document.querySelectorAll('.nav-menu .dropdown, #nav-inventory').forEach(element => {
            element.style.display = 'none';
          });
          if (onlineRecordsNav) {
            onlineRecordsNav.parentElement.style.display = 'none';
          }
      }
    }

    // Logout Functionality
    logoutButton.addEventListener('click', () => {
      const user = auth.currentUser;
      if (user) {
        // 更新用户的在线状态为离线
        db.ref(`onlineRecords/${user.uid}`).update({
          isOnline: false,
          lastActive: new Date().toISOString()
        }).then(() => {
          auth.signOut();
        });
      }
    });

    // Add Stock In - Office Functionality
    stockInOfficeButton.addEventListener('click', () => {
      const name = stockInOfficeNameInput.value.trim();
      const category = document.getElementById('stock-in-office-category').value; // Get the hidden category value
      const quantity = stockInOfficeQuantityInput.value.trim();
      const unit = stockInOfficeUnitInput.value.trim();
      const expiredDate = stockInOfficeExpiredDateInput.value; // Optional
      const location = stockInOfficeLocationSelect.value;

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInOfficeError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Basic Validation
      if (name === '' || quantity === '' || unit === '' || location === '') {
        stockInOfficeError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInOfficeError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Determine Target Path
      let targetPath = null;

      if (userRole === 'admin' || userRole === 'admino') {
        targetPath = 'inventory/office';
      } else if (userRole === 'admink') {
        targetPath = 'inventory/kepayan';
      } else {
        // Regular users likely do not have permission to perform stock in
        targetPath = null;
      }

      if (!targetPath) {
        stockInOfficeError.textContent = 'You do not have permission to perform this action.';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // Prepare Data Object
      const itemData = {
        type: 'stock-in',
        name,
        category, // Add the category to the item data
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // ISO 8601 format
        modifiedTime: new Date().toISOString(), // ISO 8601 format
        modifiedBy: user.displayName || 'Unknown'
      };

      // If expiry date is provided, add to data object
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInOfficeError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Update transaction record to include category
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: 'Office', // Explicitly set category to 'Office'
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(),
            user: user.displayName || 'Unknown',
            comment: 'None'
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInOfficeError.textContent = '';
          stockInOfficeNameInput.value = '';
          stockInOfficeQuantityInput.value = '';
          stockInOfficeUnitInput.value = '';
          stockInOfficeExpiredDateInput.value = '';
          stockInOfficeLocationSelect.value = 'office';
        }
        hideLoading();
      });
    });

    // Add Stock In - Kepayan - Seafood Functionality
    stockInKepayanSeafoodButton.addEventListener('click', () => {
      const name = stockInKepayanSeafoodNameInput.value.trim();
      const category = stockInKepayanSeafoodCategorySelect.value;
      const quantity = stockInKepayanSeafoodQuantityInput.value.trim();
      const unit = stockInKepayanSeafoodUnitInput.value.trim();
      const expiredDate = stockInKepayanSeafoodExpiredDateInput.value;
      const location = stockInKepayanSeafoodLocationSelect.value; // 'office' or 'kepayan'

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanSeafoodError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Validate Fields
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanSeafoodError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanSeafoodError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Determine Target Path
      let targetPath;
      if (location === 'office') {
        targetPath = 'inventory/office';
      } else if (location === 'kepayan') {
        targetPath = 'inventory/kepayan';
      } else {
        // If there are more locations, handle accordingly
        stockInKepayanSeafoodError.textContent = 'Unknown location, unable to add to inventory.';
        hideLoading();
        return;
      }

      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(), // ISO 8601 format
        modifiedTime: new Date().toISOString(), // ISO 8601 format
        modifiedBy: user.displayName || 'Unknown'
      };

      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanSeafoodError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Record transaction
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(), // ISO 8601 format
            user: user.displayName || 'Unknown',
            comment: 'None' // Default comment
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInKepayanSeafoodError.textContent = '';
          stockInKepayanSeafoodNameInput.value = '';
          stockInKepayanSeafoodCategorySelect.value = 'Seafood';
          stockInKepayanSeafoodQuantityInput.value = '';
          stockInKepayanSeafoodUnitInput.value = '';
          stockInKepayanSeafoodExpiredDateInput.value = '';
          stockInKepayanSeafoodLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // Add Stock In - Kepayan - Packaged Food Functionality
    stockInKepayanPackagedButton.addEventListener('click', () => {
      const name = stockInKepayanPackagedNameInput.value.trim();
      const category = stockInKepayanPackagedCategorySelect.value;
      const quantity = stockInKepayanPackagedQuantityInput.value.trim();
      const unit = stockInKepayanPackagedUnitInput.value.trim();
      const expiredDate = stockInKepayanPackagedExpiredDateInput.value;
      const location = stockInKepayanPackagedLocationSelect.value;

      // Permission Check
      if (!canPerformAction('stock-in', location)) {
        stockInKepayanPackagedError.textContent = 'You do not have permission to perform this action.';
        return;
      }

      // Basic Validation
      if (name === '' || category === '' || quantity === '' || unit === '' || location === '') {
        stockInKepayanPackagedError.textContent = 'Please fill in all required fields.';
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        stockInKepayanPackagedError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Use the same path for both admin and admink
      const targetPath = 'inventory/kepayan';
      const inventoryRef = db.ref(targetPath);
      const newItemRef = inventoryRef.push();

      // Prepare Data Object
      const itemData = {
        type: 'stock-in',
        name,
        category,
        quantity: Number(quantity),
        unit,
        location,
        createdTime: new Date().toISOString(),
        modifiedTime: new Date().toISOString(),
        modifiedBy: user.displayName || 'Unknown'
      };

      // If expiry date is provided, add to data object
      if (expiredDate) {
        itemData.expiredDate = expiredDate;
      }

      newItemRef.set(itemData, (error) => {
        if (error) {
          stockInKepayanPackagedError.textContent = 'Failed to add stock in item: ' + error.message;
        } else {
          // Add transaction record
          const transactionData = {
            type: 'stock-in',
            productName: name,
            category: category || 'N/A',
            quantity: Number(quantity),
            unit: unit,
            location: location,
            time: new Date().toISOString(),
            user: user.displayName || 'Unknown',
            comment: 'None'
          };
          db.ref('transactions').push(transactionData);

          // Clear form
          stockInKepayanPackagedError.textContent = '';
          stockInKepayanPackagedNameInput.value = '';
          stockInKepayanPackagedCategorySelect.value = '';
          stockInKepayanPackagedQuantityInput.value = '';
          stockInKepayanPackagedUnitInput.value = '';
          stockInKepayanPackagedExpiredDateInput.value = '';
          stockInKepayanPackagedLocationSelect.value = 'kepayan';
        }
        hideLoading();
      });
    });

    // Load Inventory List and Set Up Real-Time Listeners
    function loadInventoryForRole() {
      const inventoryPaths = getInventoryPaths();
      inventoryTableBody.innerHTML = '';
      inventoryCardsContainer.innerHTML = '';
      inventoryMessage.textContent = '';
      
      // First, remove any existing listeners
      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);
        inventoryRef.off(); // Remove all existing listeners before adding new ones
      });
      
      // Initialize sortable headers
      updateInventoryTableHeader();

      if (inventoryPaths.length === 0) {
        inventoryMessage.textContent = 'You do not have permission to view any inventory.';
        return;
      }

      let allItems = {};

      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);

        // Listen for child added
        inventoryRef.on('child_added', (snapshot) => {
          const item = { id: snapshot.key, ...snapshot.val() };
          // Check if item already exists before adding
          if (!allItems[item.id]) {
            allItems[item.id] = item;
            addItemToDOM(item);
            sortInventory();
          }
        });

        // Listen for child changed
        inventoryRef.on('child_changed', (snapshot) => {
          const updatedItem = { id: snapshot.key, ...snapshot.val() };
          allItems[updatedItem.id] = updatedItem;
          updateItemInDOM(updatedItem);
          sortInventory();
        });

        // Listen for child removed
        inventoryRef.on('child_removed', (snapshot) => {
          const removedItemId = snapshot.key;
          delete allItems[removedItemId];
          removeItemFromDOM(removedItemId);
          sortInventory();
        });
      });

      // Display message if no data exists
      Promise.all(inventoryPaths.map(path => db.ref(path).once('value')))
        .then((snapshots) => {
          const hasData = snapshots.some(snapshot => snapshot.exists());
          if (!hasData) {
            inventoryMessage.textContent = 'No inventory data available.';
          }
        })
        .catch(error => {
          console.error('Failed to load inventory data:', error);
          inventoryMessage.textContent = 'Failed to load inventory data: ' + error.message;
        });
    }

    // Add Inventory Item to DOM
    function addItemToDOM(item) {
      const tr = createTableRow(item);
      inventoryTableBody.appendChild(tr);

      const card = createCard(item);
      card.setAttribute('data-item-id', item.id);
      inventoryCardsContainer.appendChild(card);
    }

    // Update Inventory Item in DOM
    function updateItemInDOM(item) {
      // Update table row
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const editButton = row.querySelector('.edit-button');
        if (editButton && editButton.getAttribute('data-item-id') === item.id) {
          const formattedExpiryDate = item.expiredDate || 'N/A';
          
          row.innerHTML = `
              <td style="padding: 4px 8px;">${item.name}</td>
              <td style="padding: 4px 8px; text-align: center;">
                  ${item.imageUrl ? `
                      <img src="${item.imageUrl}" alt="Product" class="inventory-image" onclick="showFullImage('${item.imageUrl}')">
                  ` : ''}
              </td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${item.category || 'N/A'}</td>
              <td style="padding: 4px 8px;">${item.quantity}</td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${item.unit}</td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${formattedExpiryDate}</td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${item.location}</td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${formatDateTime(item.modifiedTime)}</td>
              <td class="hide-on-mobile" style="padding: 4px 8px;">${item.modifiedBy}</td>
              <td style="padding: 4px 8px;">
                  <div style="display: flex; gap: 4px; justify-content: flex-start;">
                      <button class="edit-button" data-item-id="${item.id}" style="padding: 2px 8px; margin: 0;">
                          <i class="fas fa-edit"></i> Edit
                      </button>
                      <button class="delete-button" data-item-id="${item.id}" data-item-name="${item.name}" style="padding: 2px 8px; margin: 0;">
                          <i class="fas fa-trash"></i> Delete
                      </button>
                  </div>
              </td>
          `;
        }
      });

      // Update card if it exists
      const card = document.querySelector(`.inventory-card[data-item-id="${item.id}"]`);
      if (card) {
          card.replaceWith(createCard(item));
      }
    }

    // Remove Inventory Item from DOM
    function removeItemFromDOM(itemId) {
      // Remove table row
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const stockOutButton = row.querySelector('.stock-out-button');
        if (stockOutButton && stockOutButton.getAttribute('data-item-id') === itemId) {
          inventoryTableBody.removeChild(row);
        }
      });

      // Remove card
      const card = inventoryCardsContainer.querySelector(`.inventory-card[data-item-id="${itemId}"]`);
      if (card) {
        inventoryCardsContainer.removeChild(card);
      }
    }

    // Create Table Row for Inventory Item
    function createTableRow(item) {
      const tr = document.createElement('tr');
      tr.style.height = '32px';
      
      // Format the expiry date if it exists
      const formattedExpiryDate = item.expiredDate || 'N/A';
      
      tr.innerHTML = `
        <td style="padding: 4px 8px;">${item.name}</td>
        <td style="padding: 4px 8px; text-align: center;">
            ${item.imageUrl ? `
                <img src="${item.imageUrl}" alt="Product" class="inventory-image" onclick="showFullImage('${item.imageUrl}')">
            ` : ''}
        </td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${item.category || 'N/A'}</td>
        <td style="padding: 4px 8px;">${item.quantity}</td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${item.unit}</td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${formattedExpiryDate}</td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${item.location}</td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${formatDateTime(item.modifiedTime)}</td>
        <td class="hide-on-mobile" style="padding: 4px 8px;">${item.modifiedBy}</td>
        <td style="padding: 4px 8px;">
            <div style="display: flex; gap: 4px; justify-content: flex-start;">
                <button class="edit-button" data-item-id="${item.id}" style="padding: 2px 8px; margin: 0;">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-button" data-item-id="${item.id}" data-item-name="${item.name}" style="padding: 2px 8px; margin: 0;">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </td>
    `;
    return tr;
    }

    // Add this new helper function to format dates
    function formatDateToDDMMYYYY(dateString) {
      const date = new Date(dateString);
      if (isNaN(date)) return 'Invalid Date';
      
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      
      return `${day}-${month}-${year}`;
    }

    // Create Card for Inventory Item (Mobile)
    function createCard(item) {
      const card = document.createElement('div');
      card.classList.add('inventory-card');
      card.setAttribute('data-item-id', item.id);
      
      card.innerHTML = `
        <p class="product-name">
          <strong>Product Name</strong>
          <span>${item.name}</span>
        </p>
        
        <p class="category">
          <strong>Category</strong>
          <span>${item.category || 'N/A'}</span>
        </p>
        
        <p class="quantity">
          <strong>Quantity</strong>
          <span>${item.quantity} ${item.unit}</span>
        </p>
        
        <p class="location">
          <strong>Location</strong>
          <span>${item.location}</span>
        </p>
        
        ${item.expiredDate ? `
        <p class="expiry">
          <strong>Expiry Date</strong>
          <span>${item.expiredDate}</span>
        </p>
        ` : ''}
        
        <p class="modified">
          <strong>Last Modified</strong>
          <span>${formatDateTime(item.modifiedTime)}</span>
        </p>
        
        <p class="modified-by">
          <strong>Modified By</strong>
          <span>${item.modifiedBy}</span>
        </p>
        
        <div class="card-actions">
          <div style="display: flex; gap: 4px; justify-content: flex-start;">
            <button class="edit-button" data-item-id="${item.id}" style="padding: 2px 8px; margin: 0;">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="delete-button" data-item-id="${item.id}" data-item-name="${item.name}" style="padding: 2px 8px; margin: 0;">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      `;
      return card;
    }

    // Open Edit Modal
    function openEditModal(itemId, type, name, category, quantity, unit, expiredDate, location, imageUrl) {
        document.getElementById('edit-item-name').value = name;
        document.getElementById('edit-item-category').value = category || '';
        document.getElementById('edit-item-quantity').value = quantity;
        document.getElementById('edit-item-unit').value = unit;
        document.getElementById('edit-item-expired-date').value = expiredDate || '';
        document.getElementById('edit-item-location').value = location;
        
        // 显示图片预览（如果有）
        const previewContainer = document.getElementById('image-preview-container');
        if (imageUrl) {
            previewContainer.innerHTML = `
                <div style="position: relative;">
                    <img src="${imageUrl}" alt="Product image" style="max-width: 100%; height: auto;">
                    <button class="delete-image-button" onclick="deleteProductImage('${imageUrl}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            previewContainer.setAttribute('data-image-url', imageUrl);
        } else {
            previewContainer.innerHTML = '';
            previewContainer.removeAttribute('data-image-url');
        }
        
        // 根据用户角色显示/隐藏图片上传部分
        const imageUploadSection = document.getElementById('image-upload-section');
        if (userRole === 'sadmin') {
            console.log('Showing image upload section for sadmin'); // 添加调试日志
            imageUploadSection.style.display = 'block';
        } else {
            console.log('Hiding image upload section for non-sadmin'); // 添加调试日志
            imageUploadSection.style.display = 'none';
        }
        
        currentEditItemId = itemId;
        document.getElementById('edit-modal').style.display = 'block';
    }

    // Close Edit Modal
    closeModalSpan.onclick = function() {
      editModal.style.display = 'none';
    }

    // Close Stock Out Modal
    closeStockOutModalSpan.onclick = function() {
      stockOutModal.style.display = 'none';
    }

    window.onclick = function(event) {
      if (event.target == editModal) {
        editModal.style.display = 'none';
      }
      if (event.target == stockOutModal) { // Added
        stockOutModal.style.display = 'none';
      }
    }

    // Save Edited Inventory Item
    saveEditButton.addEventListener('click', () => {
        const name = document.getElementById('edit-item-name').value.trim();
        const category = document.getElementById('edit-item-category').value;
        const quantity = document.getElementById('edit-item-quantity').value;
        const unit = document.getElementById('edit-item-unit').value.trim();
        const expiredDate = document.getElementById('edit-item-expired-date').value.trim();
        const location = document.getElementById('edit-item-location').value;
        const imageUrl = document.getElementById('image-preview-container').getAttribute('data-image-url');
        
        // Basic validation
        if (!name || !category || !quantity || !unit || !location) {
            document.getElementById('edit-item-error').textContent = 'Please fill in all required fields.';
            return;
        }

        // Validate expiry date format if provided
        if (expiredDate && !/^\d{2}-\d{2}-\d{4}$/.test(expiredDate)) {
            document.getElementById('edit-item-error').textContent = 'Invalid date format. Please use DD-MM-YYYY';
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            document.getElementById('edit-item-error').textContent = 'User not authenticated.';
            return;
        }

        showLoading();

        // Get the correct inventory path based on location
        const inventoryPath = `inventory/${location}`;
        const itemRef = db.ref(`${inventoryPath}/${currentEditItemId}`);

        // 获取当前项目的数据
        itemRef.once('value')
            .then((snapshot) => {
                const currentData = snapshot.val();
                
                // 准备更新数据
                const updateData = {
                    name,
                    category,
                    quantity: Number(quantity),
                    unit,
                    expiredDate: expiredDate || null,
                    location
                };

                // 只有在其他字段（非图片）发生变化时才更新修改时间和修改人
                if (name !== currentData.name ||
                    category !== currentData.category ||
                    Number(quantity) !== currentData.quantity ||
                    unit !== currentData.unit ||
                    expiredDate !== currentData.expiredDate ||
                    location !== currentData.location) {
                    
                    updateData.modifiedTime = new Date().toISOString();
                    updateData.modifiedBy = user.displayName || 'Unknown';
                }

                // 保持现有的图片URL
                if (imageUrl) {
                    updateData.imageUrl = imageUrl;
                }

                // 更新数据
                return itemRef.update(updateData);
            })
            .then(() => {
                // Close modal and refresh inventory
                document.getElementById('edit-modal').style.display = 'none';
                loadInventoryForRole();
            })
            .catch((error) => {
                console.error('Edit Error:', error);
                document.getElementById('edit-item-error').textContent = 'Failed to save changes: ' + error.message;
            })
            .finally(() => {
                hideLoading();
            });
    });

    // Add date input validation
    document.getElementById('edit-item-expired-date').addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Remove any non-digit characters
        value = value.replace(/\D/g, '');
        
        // Add hyphens automatically
        if (value.length > 4) {
            value = value.slice(0,2) + '-' + value.slice(2,4) + '-' + value.slice(4);
        } else if (value.length > 2) {
            value = value.slice(0,2) + '-' + value.slice(2);
        }
        
        // Limit the total length
        if (value.length > 10) {
            value = value.slice(0, 10);
        }
        
        e.target.value = value;
    });

    // Event Delegation: Click on "Stock Out" Button to Open Stock Out Modal
    document.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('stock-out-button')) {
        currentStockOutItemId = e.target.getAttribute('data-item-id');
        stockOutQuantityInput.value = '';
        stockOutCommentInput.value = ''; // Reset to default
        stockOutError.textContent = '';
        stockOutModal.style.display = 'block';
      }

      // Click on Inventory Card to Open Edit Modal (Ensure it's not the Stock Out Button)
      if (e.target && e.target.closest('.inventory-card') && !e.target.classList.contains('stock-out-button')) {
        const card = e.target.closest('.inventory-card');
        const itemId = card.getAttribute('data-item-id');
        const user = auth.currentUser;
        if (user) {
          // Since inventory is shared, traverse all paths to find the item
          const inventoryPaths = getInventoryPaths();
          let found = false;

          inventoryPaths.forEach(path => {
            if (found) return;
            const itemRef = db.ref(`${path}/${itemId}`);
            itemRef.once('value', (snapshot) => {
              const item = snapshot.val();
              if (item && !found) {
                found = true;
                openEditModal(itemId, item.type, item.name, item.category, item.quantity, item.unit, item.expiredDate, item.location, item.imageUrl);
              }
            });
          });
        }
      }
    });

    // Save Stock Out Operation
    confirmStockOutButton.addEventListener('click', () => {
      const quantityToOut = stockOutQuantityInput.value.trim();
      const comment = stockOutCommentInput.value;
      const commentSelect = document.getElementById('stock-out-comment');

      // Basic Validation
      if (quantityToOut === '' || isNaN(quantityToOut) || Number(quantityToOut) <= 0) {
        stockOutError.textContent = 'Please enter a valid quantity greater than 0.';
        return;
      }

      // Validate Comment Selection
      if (comment === '') {
        stockOutError.textContent = 'Please select a comment.';
        commentSelect.classList.add('select-error'); // Add error style
        return;
      } else {
        commentSelect.classList.remove('select-error'); // Remove error style
      }

      const quantityNumber = Number(quantityToOut);

      const user = auth.currentUser;
      if (!user) {
        stockOutError.textContent = 'User not authenticated.';
        return;
      }

      showLoading();

      // Find the inventory item path
      const inventoryPaths = getInventoryPaths();
      let itemFound = false;

      inventoryPaths.forEach(path => {
        if (itemFound) return;

        const itemRef = db.ref(`${path}/${currentStockOutItemId}`);
        itemRef.once('value', (snapshot) => {
          const item = snapshot.val();
          if (item && item.quantity >= quantityNumber) {
            itemFound = true;
            const newQuantity = item.quantity - quantityNumber;

            // Update inventory quantity
            itemRef.update({
              quantity: newQuantity,
              modifiedTime: new Date().toISOString(), // ISO 8601 format
              modifiedBy: user.displayName || 'Unknown'
            }, (error) => {
              if (error) {
                stockOutError.textContent = 'Stock out failed: ' + error.message;
                hideLoading();
              } else {
                // Record transaction
                const transactionData = {
                  type: 'stock-out',
                  productName: item.name,
                  category: item.category || 'N/A',
                  quantity: quantityNumber,
                  unit: item.unit || 'N/A',
                  location: item.location,
                  time: new Date().toISOString(), // ISO 8601 format
                  user: user.displayName || 'Unknown',
                  comment: comment // Selected comment
                };
                db.ref('transactions').push(transactionData)
                  .then(() => {
                    stockOutError.textContent = '';
                    stockOutModal.style.display = 'none';
                  })
                  .catch((error) => {
                    stockOutError.textContent = 'Failed to record transaction: ' + error.message;
                  })
                  .finally(() => {
                    hideLoading();
                  });
              }
            });
          } else if (item && item.quantity < quantityNumber) {
            stockOutError.textContent = 'Stock out quantity exceeds available inventory.';
            hideLoading();
          }
        });
      });

      // If inventory item not found or invalid quantity
      setTimeout(() => {
        if (!itemFound) {
          stockOutError.textContent = 'Inventory item not found or invalid stock out quantity.';
          hideLoading();
        }
      }, 1000);
    });

    // Show Specific Section and Hide Others
    function showSection(section) {
      document.getElementById('inventory-list-section').style.display = 'none';
      document.getElementById('stock-in-office-section').style.display = 'none';
      document.getElementById('stock-in-kepayan-seafood-section').style.display = 'none';
      document.getElementById('stock-in-kepayan-packaged-section').style.display = 'none';
      document.getElementById('transaction-records-section').style.display = 'none';
      document.getElementById('stock-out-section').style.display = 'none';
      document.getElementById('online-records-section').style.display = 'none'; // Add this line

      switch(section) {
        case 'inventory':
          document.getElementById('inventory-list-section').style.display = 'block';
          break;
        case 'stock-in-office':
          document.getElementById('stock-in-office-section').style.display = 'block';
          break;
        case 'stock-in-kepayan-seafood':
          document.getElementById('stock-in-kepayan-seafood-section').style.display = 'block';
          break;
        case 'stock-in-kepayan-packaged':
          document.getElementById('stock-in-kepayan-packaged-section').style.display = 'block';
          break;
        case 'transaction-records':
          document.getElementById('transaction-records-section').style.display = 'block';
          loadTransactionRecords(); // Load transaction records
          break;
        case 'stock-out':
          document.getElementById('stock-out-section').style.display = 'block';
          loadStockOutItems(); // Load stock out items
          break;
        case 'online-records': // Add this case
          document.getElementById('online-records-section').style.display = 'block';
          loadOnlineRecords(); // Load online records
          break;
        default:
          document.getElementById('inventory-list-section').style.display = 'block';
      }

      // Add this line to ensure proper responsive display
      handleResponsiveView();
    }

    // Add Event Listeners to Navigation Links
    document.getElementById('nav-inventory').addEventListener('click', (e) => {
      e.preventDefault();
      showSection('inventory');
    });

    navStockInOffice.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-office');
    });

    navStockInKepayanSeafood.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-seafood');
    });

    navStockInKepayanPackaged.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-in-kepayan-packaged');
    });

    navTransactionRecords.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('transaction-records');
    });

    navStockOut.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('stock-out');
      loadStockOutItems();
    });

    document.getElementById('nav-online-records').addEventListener('click', (e) => {
      e.preventDefault();
      showSection('online-records');
    });

    // Search Functionality for Inventory List
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', () => {
      const query = searchInput.value.toLowerCase();
      const category = document.getElementById('inventory-category-filter').value;
      filterInventory(query, category);
    });

    // Add category filter event listener
    document.getElementById('inventory-category-filter').addEventListener('change', () => {
      const query = searchInput.value.toLowerCase();
      const category = document.getElementById('inventory-category-filter').value;
      filterInventory(query, category);
    });

    // Update filterInventory function to handle both search and category filtering
    function filterInventory(query, category) {
      // Filter Table Rows
      const rows = inventoryTableBody.querySelectorAll('tr');
      rows.forEach(row => {
        const productName = row.cells[0].textContent.toLowerCase(); // 第一列是产品名称
        const itemCategory = row.cells[2].textContent; // 第三列是分类（因为第二列是图片）
        
        const matchesSearch = productName.includes(query);
        const matchesCategory = category === 'all' || itemCategory === category;
        
        row.style.display = matchesSearch && matchesCategory ? '' : 'none';
      });

      // Filter Inventory Cards
      const cards = inventoryCardsContainer.querySelectorAll('.inventory-card');
      cards.forEach(card => {
        const productName = card.querySelector('.product-name span').textContent.toLowerCase();
        const itemCategory = card.querySelector('.category span').textContent;
        
        const matchesSearch = productName.includes(query);
        const matchesCategory = category === 'all' || itemCategory === category;
        
        card.style.display = matchesSearch && matchesCategory ? '' : 'none';
      });
    }

    // Populate <select> Options Function (If Needed)
    function populateSelectOptions(selectElement, data, category, role, locationFilter) {
      // Clear existing options, keeping the first "Select Product" option
      selectElement.innerHTML = '<option value="">Select Product</option>';
      
      if (data) {
        let items = Object.keys(data)
          .filter(key => {
            if (category && data[key].category !== category) return false;
            if (locationFilter && data[key].location !== locationFilter) return false;
            if (data[key].type === 'stock-out') return false; // Only show stock-in types
            return data[key].quantity > 0;
          })
          .map(key => data[key].name);

        // Remove duplicate product names
        const uniqueItems = [...new Set(items)];

        uniqueItems.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          selectElement.appendChild(option);
        });
      }
    }

    // Load Transaction Records and Set Up Real-Time Listeners
    function loadTransactionRecords() {
      showLoading();
      const dateFilter = document.getElementById('transaction-date-filter').value;
      const customDate = document.getElementById('transaction-custom-date').value;
      
      // Calculate date ranges
      const now = new Date();
      now.setHours(23, 59, 59, 999); // End of day
      
      let startDate = new Date();
      startDate.setHours(0, 0, 0, 0); // Start of day
      
      switch(dateFilter) {
        case 'today':
          // Already set correctly
          break;
        case 'yesterday':
          startDate.setDate(startDate.getDate() - 1);
          now.setDate(now.getDate() - 1);
          break;
        case 'last7days':
          startDate.setDate(startDate.getDate() - 7);
          break;
        case 'last30days':
          startDate.setDate(startDate.getDate() - 30);
          break;
        case 'custom':
          if (customDate) {
            startDate = new Date(customDate);
            startDate.setHours(0, 0, 0, 0);
            now.setTime(startDate.getTime());
            now.setHours(23, 59, 59, 999);
          }
          break;
        case 'all':
          startDate = new Date(0); // Beginning of time
          break;
      }

      // 添加日期显示
      const dateDisplay = document.createElement('div');
      dateDisplay.style.marginBottom = '15px';
      dateDisplay.style.fontWeight = 'bold';
      dateDisplay.textContent = `Showing records for: ${formatDateDisplay(startDate, now, dateFilter)}`;
      
      // 清除旧的日期显示（如果存在）
      const oldDateDisplay = document.querySelector('.date-display');
      if (oldDateDisplay) {
        oldDateDisplay.remove();
      }
      
      // 在表格前插入日期显示
      document.querySelector('#transaction-records-section h3').insertAdjacentElement('afterend', dateDisplay);
      dateDisplay.classList.add('date-display');

      // 获取当前用户角色
      const isSadmin = userRole === 'sadmin';
      
      db.ref('transactions')
        .orderByChild('time')
        .startAt(startDate.toISOString())
        .endAt(now.toISOString())
        .once('value')
        .then((snapshot) => {
          const data = snapshot.val();
          
          // 清空表格内容
          const transactionTable = document.getElementById('transaction-records-table');
          transactionTable.innerHTML = `
            <thead>
              <tr>
                <th>Product Name</th>
                <th>Category</th>
                <th>Quantity</th>
                <th>Transaction Time</th>
                <th>Modified By</th>
                <th>Comment</th>
                ${userRole === 'sadmin' ? '<th>Action</th>' : ''}
              </tr>
            </thead>
            <tbody></tbody>
          `;
          
          const tbody = transactionTable.querySelector('tbody');
          
          // 清除之前的统计信息面板
          const existingStats = document.querySelector('.transaction-stats');
          if (existingStats) {
            existingStats.remove();
          }

          if (data) {
            // 过滤掉 edited 和 deleted 类型的记录，只保留 stock-in 和 stock-out
            const records = Object.entries(data)
              .filter(([, record]) => record.type === 'stock-in' || record.type === 'stock-out')
              .sort(([,a], [,b]) => new Date(b.time) - new Date(a.time));
            
            // 修改统计对象的结构
            const stockInStats = {
              byCategory: {}, // 按 category 统计
              byComment: {}   // 按 comment 统计
            };
            const stockOutStats = {}; // stock out 保持原样
            
            records.forEach(([, record]) => {
              if (record.type === 'stock-in') {
                // 统计 category
                const category = record.category || 'Uncategorized';
                if (!stockInStats.byCategory[category]) {
                  stockInStats.byCategory[category] = {
                    ctn: 0,
                    pkt: 0,
                    pieces: 0
                  };
                }
                const unit = record.unit.toLowerCase();
                if (unit === 'ctn' || unit === 'pkt' || unit === 'pieces') {
                  stockInStats.byCategory[category][unit] += record.quantity;
                }
              } else if (record.type === 'stock-out') {
                // Stock Out 统计保持不变
                const comment = record.comment || 'None';
                if (!stockOutStats[comment]) {
                  stockOutStats[comment] = {
                    ctn: 0,
                    pkt: 0,
                    pieces: 0
                  };
                }
                const unit = record.unit.toLowerCase();
                if (unit === 'ctn' || unit === 'pkt' || unit === 'pieces') {
                  stockOutStats[comment][unit] += record.quantity;
                }
              }
            });

            // 创建 Stock In 的 category 统计 HTML
            function createCategoryStats(categoryStats) {
              return Object.entries(categoryStats)
                .map(([category, quantities]) => {
                  const quantityStrings = [];
                  if (quantities.ctn > 0) quantityStrings.push(`${quantities.ctn} ctn`);
                  if (quantities.pkt > 0) quantityStrings.push(`${quantities.pkt} pkt`);
                  if (quantities.pieces > 0) quantityStrings.push(`${quantities.pieces} pieces`);
                  
                  if (quantityStrings.length > 0) {
                    return `
                      <div class="comment-stat">
                        <div class="comment-name">${category}</div>
                        <div class="comment-quantity">${quantityStrings.join(', ')}</div>
                      </div>
                    `;
                  }
                  return '';
                })
                .filter(html => html !== '')
                .join('');
            }

            // Stock Out 的统计 HTML 保持不变
            function createCommentStats(stats) {
              return Object.entries(stats)
                .map(([comment, quantities]) => {
                  const quantityStrings = [];
                  if (quantities.ctn > 0) quantityStrings.push(`${quantities.ctn} ctn`);
                  if (quantities.pkt > 0) quantityStrings.push(`${quantities.pkt} pkt`);
                  if (quantities.pieces > 0) quantityStrings.push(`${quantities.pieces} pieces`);
                  
                  if (quantityStrings.length > 0) {
                    return `
                      <div class="comment-stat">
                        <div class="comment-name">${comment}</div>
                        <div class="comment-quantity">${quantityStrings.join(', ')}</div>
                      </div>
                    `;
                  }
                  return '';
                })
                .filter(html => html !== '')
                .join('');
            }

            const statsHtml = `
              <div class="transaction-stats">
                <div class="stat-card">
                  <div class="stat-title">Stock In by Category</div>
                  <div class="stat-content">
                    ${createCategoryStats(stockInStats.byCategory) || '<div class="no-data">No stock in today</div>'}
                  </div>
                </div>
                <div class="stat-card">
                  <div class="stat-title">Stock Out</div>
                  <div class="stat-content">
                    ${createCommentStats(stockOutStats) || '<div class="no-data">No stock out today</div>'}
                  </div>
                </div>
              </div>
            `;

            // 插入新的统计信息面板
            document.querySelector('#transaction-records-section h3').insertAdjacentHTML('afterend', statsHtml);
            
            records.forEach(([recordId, record]) => {
              const tr = document.createElement('tr');
              
              // 确定交易类型的样式和图标
              const typeClass = record.type === 'stock-in' ? 'type-in' : 'type-out';
              const typeIcon = record.type === 'stock-in' ? 'fa-arrow-circle-up' : 'fa-arrow-circle-down';
              
              // 格式化数量显示
              const quantityClass = record.type === 'stock-in' ? 'quantity-in' : 'quantity-out';
              const quantitySign = record.type === 'stock-in' ? '+' : '-';
              
              tr.innerHTML = `
                <td>
                  <span class="transaction-type ${typeClass}">
                    <i class="fas ${typeIcon} mr-1"></i>
                    ${record.type === 'stock-in' ? 'IN' : 'OUT'}
                  </span>
                  ${record.productName}
                </td>
                <td>${record.category || 'N/A'}</td>
                <td class="${quantityClass}">${quantitySign}${Math.abs(record.quantity)} ${record.unit}</td>
                <td>${formatDateTime(record.time)}</td>
                <td>${record.user}</td>
                <td>
                  <span class="badge ${record.comment === 'None' ? 'bg-secondary' : 'bg-primary'}" style="padding: 5px 10px;">
                    ${record.comment}
                  </span>
                </td>
                ${userRole === 'sadmin' ? `
                <td>
                  <button class="delete-transaction-button" data-id="${recordId}">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
                ` : ''}
              `;
              
              tbody.appendChild(tr);
            });
          } else {
            tbody.innerHTML = '<tr><td colspan="7">No transaction records found for the selected period.</td></tr>';
          }
        })
        .catch((error) => {
          console.error('Failed to load transaction records:', error);
          transactionRecordsMessage.textContent = 'Failed to load transaction records: ' + error.message;
        })
        .finally(() => {
          hideLoading();
        });
    }

    // 添加一个辅助函数来格式化日期显示
    function formatDateDisplay(startDate, endDate, filterType) {
      const formatDate = (date) => {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}-${month}-${year}`;
      };

      switch(filterType) {
        case 'today':
          return `Today (${formatDate(startDate)})`;
        case 'yesterday':
          return `Yesterday (${formatDate(startDate)})`;
        case 'last7days':
          return `Last 7 Days (${formatDate(startDate)} to ${formatDate(endDate)})`;
        case 'last30days':
          return `Last 30 Days (${formatDate(startDate)} to ${formatDate(endDate)})`;
        case 'custom':
          return `${formatDate(startDate)}`;
        case 'all':
          return 'All Records';
        default:
          return '';
      }
    }

    // 添加事件监听器
    document.getElementById('transaction-date-filter').addEventListener('change', (e) => {
      const customDateInput = document.getElementById('transaction-custom-date');
      if (e.target.value === 'custom') {
        customDateInput.style.display = 'inline-block';
        // 设置日期选择器的默认值为今天
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        customDateInput.value = `${year}-${month}-${day}`;
      } else {
        customDateInput.style.display = 'none';
        loadTransactionRecords();
      }
    });

    document.getElementById('transaction-custom-date').addEventListener('change', () => {
      loadTransactionRecords();
    });

    // Sort Inventory List by Modified Time Descending
    function sortInventory() {
      // Get all rows from table
      const rows = Array.from(inventoryTableBody.querySelectorAll('tr'));
      // Sort rows based on the 'Last Modified Time' column (7th index, zero-based)
      rows.sort((a, b) => {
        const aTime = new Date(a.children[6].textContent.replace('(', '').replace(')', ''));
        const bTime = new Date(b.children[6].textContent.replace('(', '').replace(')', ''));
        return bTime - aTime;
      });
      // Append sorted rows back to the table body
      inventoryTableBody.innerHTML = '';
      rows.forEach(row => inventoryTableBody.appendChild(row));

      // Similarly sort cards based on 'modifiedTime' if needed
      // Assuming we have a data structure to sort cards, otherwise skip
    }

    // Show Loading Indicator
    function showLoading() {
      loadingIndicator.style.display = 'block';
    }

    // Hide Loading Indicator
    function hideLoading() {
      loadingIndicator.style.display = 'none';
    }

    // Check if User Can Perform Specific Action Based on Role and Location
    function canPerformAction(action, location) {
      switch(userRole) {
        case 'admin':
        case 'sadmin': // Added 'sadmin'
          return true;
        case 'adminv':
          return action === 'view'; // adminv can only view
        case 'admino':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'office';
        case 'admink':
          return (action === 'view' || action === 'stock-in' || action === 'stock-out') && location === 'kepayan';
        case 'user':
          return action === 'view'; // user can only view inventory list
        default:
          return false;
      }
    }

    // Perform Action with Permission Check
    function performAction(action, location, callback) {
      if (canPerformAction(action, location)) {
        callback();
      } else {
        alert('You do not have permission to perform this action.');
      }
    }

    // Handle Responsive View for Tables and Cards
    function handleResponsiveView() {
      const tableResponsive = document.querySelector('.table-responsive');
      const cardsContainer = document.getElementById('inventory-cards');
      const transactionTable = document.getElementById('transaction-records-table');
      const transactionCards = document.getElementById('transaction-records-cards');

      if (window.innerWidth <= 600) {
        // Mobile view
        if (tableResponsive) tableResponsive.style.display = 'none';
        if (cardsContainer) cardsContainer.style.display = 'flex';
        if (transactionTable) transactionTable.parentElement.style.display = 'none';
        if (transactionCards) transactionCards.style.display = 'flex';
      } else {
        // Desktop view
        if (tableResponsive) tableResponsive.style.display = 'block';
        if (cardsContainer) cardsContainer.style.display = 'none';
        if (transactionTable) transactionTable.parentElement.style.display = 'block';
        if (transactionCards) transactionCards.style.display = 'none';
      }
    }

    // Initialize View Based on Current Window Size
    window.addEventListener('load', handleResponsiveView);

    // Adjust View on Window Resize
    window.addEventListener('resize', handleResponsiveView);

    // Create and Sort Inventory Items
    // Already handled in addItemToDOM and updateItemInDOM by calling sortInventory()

    // Load Inventory List on Role Assignment
    // Already handled in loadInventoryForRole()

    // Toggle Password Visibility
    const togglePassword = document.getElementById('toggle-password');
    togglePassword.addEventListener('click', () => {
      const passwordInput = document.getElementById('login-password');
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      togglePassword.classList.toggle('fa-eye-slash');
    });

    // Forgot Password Functionality
    const forgotPasswordLink = document.getElementById('forgot-password');
    forgotPasswordLink.addEventListener('click', (e) => {
      e.preventDefault();
      const email = document.getElementById('login-email').value.trim();
      if (email === '') {
        alert('Please enter your email address to reset your password.');
        return;
      }
      showLoading();
      auth.sendPasswordResetEmail(email)
        .then(() => {
          alert('Password reset email sent. Please check your inbox.');
        })
        .catch((error) => {
          console.error('Password Reset Error:', error);
          alert('Failed to send password reset email: ' + error.message);
        })
        .finally(() => {
          hideLoading();
        });
    });

    // Load items for stock out
    function loadStockOutItems() {
      const tbody = stockOutTable.querySelector('tbody');
      tbody.innerHTML = '';
      
      const inventoryPaths = getInventoryPaths();
      inventoryPaths.forEach(path => {
        const inventoryRef = db.ref(path);
        inventoryRef.once('value', (snapshot) => {
          snapshot.forEach((childSnapshot) => {
            const item = childSnapshot.val();
            if (item.quantity > 0) {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td><input type="checkbox" class="item-checkbox" data-id="${childSnapshot.key}" data-path="${path}"></td>
                <td>${item.name}</td>
                <td>${item.category || 'N/A'}</td>
                <td>${item.quantity}</td>
                <td>${item.unit}</td>
                <td>${item.location}</td>
                <td><input type="number" class="stock-out-quantity" min="1" max="${item.quantity}" disabled></td>
              `;
              tbody.appendChild(tr);
            }
          });
        });
      });
    }

    // Handle select all checkbox
    selectAllItems.addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.item-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = e.target.checked;
        const quantityInput = checkbox.closest('tr').querySelector('.stock-out-quantity');
        quantityInput.disabled = !e.target.checked;
      });
      updateBatchStockOutButton();
    });

    // Handle individual checkboxes
    stockOutTable.addEventListener('change', (e) => {
      if (e.target.classList.contains('item-checkbox')) {
        const quantityInput = e.target.closest('tr').querySelector('.stock-out-quantity');
        quantityInput.disabled = !e.target.checked;
        updateBatchStockOutButton();
      }
    });

    // Update batch stock out button state
    function updateBatchStockOutButton() {
      const checkedItems = document.querySelectorAll('.item-checkbox:checked');
      batchStockOutButton.disabled = checkedItems.length === 0;
    }

    // Handle batch stock out
    batchStockOutButton.addEventListener('click', async () => {
      const comment = document.getElementById('stock-out-comment').value;
      if (!comment) {
        alert('Please select a comment for the stock out operation.');
        return;
      }

      const checkedItems = document.querySelectorAll('.item-checkbox:checked');
      const stockOutPromises = [];
      const user = auth.currentUser;

      checkedItems.forEach(checkbox => {
        const tr = checkbox.closest('tr');
        const quantityInput = tr.querySelector('.stock-out-quantity');
        const quantity = parseInt(quantityInput.value);
        const itemId = checkbox.getAttribute('data-id');
        const path = checkbox.getAttribute('data-path');

        if (quantity > 0) {
          const itemRef = db.ref(`${path}/${itemId}`);
          stockOutPromises.push(
            itemRef.once('value').then(snapshot => {
              const item = snapshot.val();
              if (item.quantity >= quantity) {
                return itemRef.update({
                  quantity: item.quantity - quantity,
                  modifiedTime: new Date().toISOString(),
                  modifiedBy: user.displayName || 'Unknown'
                }).then(() => {
                  // Add transaction record
                  return db.ref('transactions').push({
                    type: 'stock-out',
                    productName: item.name,
                    category: item.category || 'N/A',
                    quantity: quantity,
                    unit: item.unit,
                    location: item.location,
                    time: new Date().toISOString(),
                    user: user.displayName || 'Unknown',
                    comment: comment
                  });
                });
              } else {
                throw new Error(`Insufficient quantity for ${item.name}`);
              }
            })
          );
        }
      });

      try {
        showLoading();
        await Promise.all(stockOutPromises);
        alert('Batch stock out completed successfully');
        loadStockOutItems(); // Reload the table
      } catch (error) {
        alert('Error processing batch stock out: ' + error.message);
      } finally {
        hideLoading();
      }
    });

    // Search and filter functionality
    stockOutSearch.addEventListener('input', filterStockOutItems);
    stockOutLocationFilter.addEventListener('change', filterStockOutItems);
    document.getElementById('stock-out-category-filter').addEventListener('change', filterStockOutItems);

    function filterStockOutItems() {
      const searchTerm = stockOutSearch.value.toLowerCase();
      const locationFilter = stockOutLocationFilter.value;
      const categoryFilter = document.getElementById('stock-out-category-filter').value;
      
      const rows = stockOutTable.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const productName = row.cells[1].textContent.toLowerCase();
        const category = row.cells[2].textContent;
        const location = row.cells[5].textContent;
        
        const matchesSearch = productName.includes(searchTerm);
        const matchesLocation = locationFilter === 'all' || location === locationFilter;
        const matchesCategory = categoryFilter === 'all' || category === categoryFilter;
        
        row.style.display = matchesSearch && matchesLocation && matchesCategory ? '' : 'none';
      });
    }

    // Handle edit button clicks
    document.addEventListener('click', (e) => {
      if (e.target.closest('.edit-button')) {
        const button = e.target.closest('.edit-button');
        const itemId = button.getAttribute('data-item-id');
        const user = auth.currentUser;
        
        if (user) {
          const inventoryPaths = getInventoryPaths();
          let found = false;

          inventoryPaths.forEach(path => {
            if (found) return;
            const itemRef = db.ref(`${path}/${itemId}`);
            itemRef.once('value', (snapshot) => {
              const item = snapshot.val();
              if (item && !found) {
                found = true;
                // Open edit modal with item data
                document.getElementById('edit-item-name').value = item.name;
                document.getElementById('edit-item-category').value = item.category || '';
                document.getElementById('edit-item-quantity').value = item.quantity;
                document.getElementById('edit-item-unit').value = item.unit;
                document.getElementById('edit-item-expired-date').value = item.expiredDate || '';
                document.getElementById('edit-item-location').value = item.location;
                
                // Store current item ID for save operation
                currentEditItemId = itemId;
                
                // Show modal
                document.getElementById('edit-modal').style.display = 'block';
              }
            });
          });
        }
      }
    });

    // Close modal when clicking outside or on close button
    window.onclick = function(event) {
      const modal = document.getElementById('edit-modal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    };

    document.querySelector('.close').onclick = function() {
      document.getElementById('edit-modal').style.display = 'none';
    };

    // Add event listener for date filter changes
    document.getElementById('transaction-date-filter').addEventListener('change', (e) => {
      const customDateInput = document.getElementById('transaction-custom-date');
      if (e.target.value === 'custom') {
        customDateInput.style.display = 'inline-block';
      } else {
        customDateInput.style.display = 'none';
        loadTransactionRecords();
      }
    });

    // Add event listener for custom date changes
    document.getElementById('transaction-custom-date').addEventListener('change', () => {
      loadTransactionRecords();
    });

    // Initialize with today's records when the section is shown
    navTransactionRecords.addEventListener('click', (e) => {
      e.preventDefault();
      showSection('transaction-records');
      document.getElementById('transaction-date-filter').value = 'today';
      loadTransactionRecords();
    });

    // 同样更新交易记录卡片的创建函数
    function createTransactionCard(record, recordId, isSadmin) {
      const card = document.createElement('div');
      card.classList.add('transaction-card');
      
      card.innerHTML = `
        <p class="product-name">
          <strong>Product Name</strong>
          <span>${record.productName}</span>
        </p>
        
        <p class="category">
          <strong>Category</strong>
          <span>${record.category || 'N/A'}</span>
        </p>
        
        <p class="quantity">
          <strong>Quantity</strong>
          <span>${record.quantity} ${record.unit}</span>
        </p>
        
        <p class="transaction-time">
          <strong>Transaction Time</strong>
          <span>${formatDateTime(record.time)}</span>
        </p>
        
        <p class="modified-by">
          <strong>Modified By</strong>
          <span>${record.user}</span>
        </p>
        
        <p class="comment">
          <strong>Comment</strong>
          <span>${record.comment || 'None'}</span>
        </p>
        
        ${isSadmin ? `
        <div class="card-actions">
          <button class="delete-transaction-button" data-id="${recordId}">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
        ` : ''}
      `;
      return card;
    }

    // Update the inventory table header to make Expiry Date sortable
    function updateInventoryTableHeader() {
      const thead = document.querySelector('#inventory-table thead tr');
      thead.innerHTML = `
        <th>Product Name</th>
        <th style="width: 100px;">Image</th>
        <th class="hide-on-mobile sortable" data-sort="category">Category ↕</th>
        <th>Quantity</th>
        <th class="hide-on-mobile">Unit</th>
        <th class="hide-on-mobile sortable" data-sort="expiry">Expiry Date ↕</th>
        <th class="hide-on-mobile">Location</th>
        <th class="hide-on-mobile">Last Modified Time</th>
        <th class="hide-on-mobile">Modified By</th>
        <th>Action</th>
      `;

      // Add click event to sortable headers
      document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
          const sortType = header.getAttribute('data-sort');
          const currentDirection = header.getAttribute('data-direction') || 'asc';
          const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
          
          // Update arrow indicator for all headers
          document.querySelectorAll('.sortable').forEach(h => {
            h.textContent = h.textContent.replace(' ↑', ' ↕').replace(' ↓', ' ↕');
          });
          header.textContent = header.textContent.replace(' ↕', newDirection === 'asc' ? ' ↑' : ' ↓');
          
          header.setAttribute('data-direction', newDirection);
          
          // Call appropriate sort function
          if (sortType === 'category') {
            sortInventoryByCategory(newDirection);
          } else if (sortType === 'expiry') {
            sortInventoryByExpiry(newDirection);
          }
        });
      });
    }

    // Add new function to sort by expiry date
    function sortInventoryByExpiry(direction = 'asc') {
      const rows = Array.from(inventoryTableBody.querySelectorAll('tr'));
      
      rows.sort((a, b) => {
        let expiryA = a.children[4].textContent;
        let expiryB = b.children[4].textContent;
        
        if (expiryA === 'N/A') {
            expiryA = direction === 'asc' ? new Date('9999-12-31') : new Date('1900-01-01');
        } else {
            const [dayA, monthA, yearA] = expiryA.split('-');
            expiryA = new Date(yearA, monthA - 1, dayA);
        }
        
        if (expiryB === 'N/A') {
            expiryB = direction === 'asc' ? new Date('9999-12-31') : new Date('1900-01-01');
        } else {
            const [dayB, monthB, yearB] = expiryB.split('-');
            expiryB = new Date(yearB, monthB - 1, dayB);
        }
        
        if (direction === 'asc') {
            return expiryA - expiryB;
        } else {
            return expiryB - expiryA;
        }
    });

      // Clear and re-append sorted rows
      inventoryTableBody.innerHTML = '';
      rows.forEach(row => inventoryTableBody.appendChild(row));

      // Sort cards for mobile view
      sortInventoryCardsByExpiry(direction);
    }

    // Add new function to sort cards by expiry date
    function sortInventoryCardsByExpiry(direction = 'asc') {
      const cards = Array.from(inventoryCardsContainer.querySelectorAll('.inventory-card'));
      
      cards.sort((a, b) => {
        let expiryA = a.querySelector('.expiry span')?.textContent || 'N/A';
        let expiryB = b.querySelector('.expiry span')?.textContent || 'N/A';
        
        // Convert expiry dates to Date objects for comparison
        if (expiryA === 'N/A') {
          expiryA = direction === 'asc' ? new Date('9999-12-31') : new Date('1900-01-01');
        } else {
          // Parse the date in YYYY-MM-DD format
          expiryA = new Date(expiryA);
        }
        
        if (expiryB === 'N/A') {
          expiryB = direction === 'asc' ? new Date('9999-12-31') : new Date('1900-01-01');
        } else {
          // Parse the date in YYYY-MM-DD format
          expiryB = new Date(expiryB);
        }
        
        // Compare dates
        if (direction === 'asc') {
          return expiryA - expiryB;
        } else {
          return expiryB - expiryA;
        }
      });

      // Clear and re-append sorted cards
      inventoryCardsContainer.innerHTML = '';
      cards.forEach(card => inventoryCardsContainer.appendChild(card));
    }

    // Sort inventory by category
    function sortInventoryByCategory(direction = 'asc') {
      const rows = Array.from(inventoryTableBody.querySelectorAll('tr'));
      
      rows.sort((a, b) => {
        const categoryA = (a.children[1].textContent || 'ZZZ').toLowerCase(); // ZZZ ensures empty categories go to the end
        const categoryB = (b.children[1].textContent || 'ZZZ').toLowerCase();
        
        if (direction === 'asc') {
          return categoryA.localeCompare(categoryB);
        } else {
          return categoryB.localeCompare(categoryA);
        }
      });

      // Clear and re-append sorted rows
      inventoryTableBody.innerHTML = '';
      rows.forEach(row => inventoryTableBody.appendChild(row));

      // Sort cards for mobile view
      sortInventoryCards(direction);
    }

    // Sort inventory cards
    function sortInventoryCards(direction = 'asc') {
      const cards = Array.from(inventoryCardsContainer.querySelectorAll('.inventory-card'));
      
      cards.sort((a, b) => {
        const categoryA = (a.querySelector('.category span').textContent || 'ZZZ').toLowerCase();
        const categoryB = (b.querySelector('.category span').textContent || 'ZZZ').toLowerCase();
        
        if (direction === 'asc') {
          return categoryA.localeCompare(categoryB);
        } else {
          return categoryB.localeCompare(categoryA);
        }
      });

      // Clear and re-append sorted cards
      inventoryCardsContainer.innerHTML = '';
      cards.forEach(card => inventoryCardsContainer.appendChild(card));
    }

    // Add this after your existing event listeners

    // Handle delete button clicks
    document.addEventListener('click', (e) => {
      if (e.target.closest('.delete-button')) {
        const button = e.target.closest('.delete-button');
        const itemId = button.getAttribute('data-item-id');
        const itemName = button.getAttribute('data-item-name');
        
        // Show confirmation dialog
        if (confirm(`Are you sure you want to delete "${itemName}"? This action cannot be undone.`)) {
          const user = auth.currentUser;
          
          if (user) {
            showLoading();
            
            // Check both inventory paths
            const inventoryPaths = ['inventory/office', 'inventory/kepayan'];
            let deletePromises = inventoryPaths.map(path => {
              return db.ref(`${path}/${itemId}`).once('value')
                .then(snapshot => {
                  if (snapshot.exists()) {
                    // Record the deletion in transactions
                    return db.ref('transactions').push({
                      type: 'delete',
                      productName: itemName,
                      category: snapshot.val().category || 'N/A',
                      quantity: snapshot.val().quantity,
                      unit: snapshot.val().unit,
                      location: snapshot.val().location,
                      time: new Date().toISOString(),
                      user: user.displayName || 'Unknown',
                      comment: 'Item deleted'
                    }).then(() => {
                      // Then delete the item
                      return db.ref(`${path}/${itemId}`).remove();
                    });
                  }
                  return Promise.resolve();
                });
            });

            Promise.all(deletePromises)
              .then(() => {
                // Remove item from DOM
                const row = button.closest('tr');
                if (row) {
                  row.remove();
                }
                
                // Also remove from cards view if exists
                const card = document.querySelector(`.inventory-card[data-item-id="${itemId}"]`);
                if (card) {
                  card.remove();
                }
              })
              .catch(error => {
                console.error('Delete Error:', error);
                alert('Failed to delete item: ' + error.message);
              })
              .finally(() => {
                hideLoading();
              });
          }
        }
      }
    });

    // Add date input validation for all stock in expiry date fields
    const dateInputs = [
        'stock-in-office-expired-date',
        'stock-in-kepayan-seafood-expired-date',
        'stock-in-kepayan-packaged-expired-date'
    ];

    dateInputs.forEach(inputId => {
        document.getElementById(inputId).addEventListener('input', function(e) {
            let value = e.target.value;
            
            // Remove any non-digit characters
            value = value.replace(/\D/g, '');
            
            // Add hyphens automatically
            if (value.length > 4) {
                value = value.slice(0,2) + '-' + value.slice(2,4) + '-' + value.slice(4);
            } else if (value.length > 2) {
                value = value.slice(0,2) + '-' + value.slice(2);
            }
            
            // Limit the total length
            if (value.length > 10) {
                value = value.slice(0, 10);
            }
            
            e.target.value = value;
        });
    });

    // Update stock in button event listeners
    stockInOfficeButton.addEventListener('click', () => {
        const name = document.getElementById('stock-in-office-name').value.trim();
        const category = document.getElementById('stock-in-office-category').value;
        const quantity = document.getElementById('stock-in-office-quantity').value;
        const unit = document.getElementById('stock-in-office-unit').value.trim();
        const expiredDate = document.getElementById('stock-in-office-expired-date').value.trim();
        const location = document.getElementById('stock-in-office-location').value;
        
        // Validate expiry date format if provided
        if (expiredDate && !/^\d{2}-\d{2}-\d{4}$/.test(expiredDate)) {
            document.getElementById('stock-in-office-error').textContent = 'Invalid date format. Please use DD-MM-YYYY';
            return;
        }
        
        // Rest of the stock in logic...
        handleStockIn('office', name, category, quantity, unit, expiredDate, location);
    });

    stockInKepayanSeafoodButton.addEventListener('click', () => {
        const name = document.getElementById('stock-in-kepayan-seafood-name').value.trim();
        const category = document.getElementById('stock-in-kepayan-seafood-category').value;
        const quantity = document.getElementById('stock-in-kepayan-seafood-quantity').value;
        const unit = document.getElementById('stock-in-kepayan-seafood-unit').value.trim();
        const expiredDate = document.getElementById('stock-in-kepayan-seafood-expired-date').value.trim();
        const location = document.getElementById('stock-in-kepayan-seafood-location').value;
        
        // Validate expiry date format if provided
        if (expiredDate && !/^\d{2}-\d{2}-\d{4}$/.test(expiredDate)) {
            document.getElementById('stock-in-kepayan-seafood-error').textContent = 'Invalid date format. Please use DD-MM-YYYY';
            return;
        }
        
        // Rest of the stock in logic...
        handleStockIn('kepayan-seafood', name, category, quantity, unit, expiredDate, location);
    });

    stockInKepayanPackagedButton.addEventListener('click', () => {
        const name = document.getElementById('stock-in-kepayan-packaged-name').value.trim();
        const category = document.getElementById('stock-in-kepayan-packaged-category').value;
        const quantity = document.getElementById('stock-in-kepayan-packaged-quantity').value;
        const unit = document.getElementById('stock-in-kepayan-packaged-unit').value.trim();
        const expiredDate = document.getElementById('stock-in-kepayan-packaged-expired-date').value.trim();
        const location = document.getElementById('stock-in-kepayan-packaged-location').value;
        
        // Validate expiry date format if provided
        if (expiredDate && !/^\d{2}-\d{2}-\d{4}$/.test(expiredDate)) {
            document.getElementById('stock-in-kepayan-packaged-error').textContent = 'Invalid date format. Please use DD-MM-YYYY';
            return;
        }
        
        // Rest of the stock in logic...
        handleStockIn('kepayan-packaged', name, category, quantity, unit, expiredDate, location);
    });

    // Update handleStockIn function
    function handleStockIn(type, name, category, quantity, unit, expiredDate, location) {
        // Basic validation
        if (!name || !category || !quantity || !unit || !location) {
            const errorElement = document.getElementById(`stock-in-${type}-error`);
            errorElement.textContent = 'Please fill in all required fields.';
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            const errorElement = document.getElementById(`stock-in-${type}-error`);
            errorElement.textContent = 'User not authenticated.';
            return;
        }

        showLoading();

        // Get inventory reference based on location
        const inventoryRef = db.ref(`inventory/${location}`);
        
        // Create new item data
        const itemData = {
            name,
            category,
            quantity: Number(quantity),
            unit,
            expiredDate: expiredDate || null, // Store as DD-MM-YYYY
            location,
            type: 'stock-in',
            modifiedTime: new Date().toISOString(),
            modifiedBy: user.displayName || 'Unknown'
        };

        // Rest of the handleStockIn logic...
    }

    // Function to load online records
    function loadOnlineRecords() {
      showLoading();
      
      // 检查当前用户是否为 sadmin
      const user = auth.currentUser;
      if (!user) {
        hideLoading();
        return;
      }

      // 获取用户角色
      db.ref(`users/${user.uid}/role`).once('value')
        .then(snapshot => {
          const role = snapshot.val();
          if (role !== 'sadmin') {
            console.error('Unauthorized access to online records');
            hideLoading();
            return;
          }

          // 如果是 sadmin，则获取所有在线记录
          return db.ref('onlineRecords').once('value');
        })
        .then(snapshot => {
          if (!snapshot) return;

          const data = snapshot.val();
          const onlineRecordsTableBody = document.getElementById('online-records-table-body');
          onlineRecordsTableBody.innerHTML = '';

          if (data) {
            Object.entries(data).forEach(([userId, record]) => {
              const tr = document.createElement('tr');
              const loginTime = new Date(record.loginTime);
              const lastActive = new Date(record.lastActive);
              
              // 添加在线状态的样式
              const onlineStatus = record.isOnline ? 
                '<span style="color: green;">Online</span>' : 
                '<span style="color: red;">Offline</span>';

              tr.innerHTML = `
                <td>${record.userName || 'Unknown'}</td>
                <td>${record.email || 'N/A'}</td>
                <td>${formatDateTime(loginTime)}</td>
                <td>${formatDateTime(lastActive)}</td>
                <td>${onlineStatus}</td>
              `;
              onlineRecordsTableBody.appendChild(tr);
            });
          } else {
            onlineRecordsTableBody.innerHTML = '<tr><td colspan="5">No online records found.</td></tr>';
          }
        })
        .catch(error => {
          console.error('Failed to load online records:', error);
        })
        .finally(() => {
          hideLoading();
        });
    }

    // 假设你有一个登录函数
    function loginUser(email, password) {
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          // 登录成功
          const user = userCredential.user;
          const userId = user.uid;
          const userName = user.displayName || 'Unknown';
          const userEmail = user.email;

          // 记录用户登录信息
          db.ref(`onlineRecords/${userId}`).set({
            userName: userName,
            email: userEmail,
            loginTime: new Date().toISOString(),
            isOnline: true
          });

          // 其他登录成功后的逻辑
        })
        .catch((error) => {
          console.error('Login Error:', error);
          // 处理登录错误
        });
    }

    // 在用户注销时更新在线状态
    function logoutUser() {
      const user = auth.currentUser;
      if (user) {
        const userId = user.uid;
        db.ref(`onlineRecords/${userId}`).update({
          isOnline: false
        });
      }
      auth.signOut().then(() => {
        // 注销成功后的逻辑
      }).catch((error) => {
        console.error('Logout Error:', error);
      });
    }

    // 添加删除交易记录的事件监听器
    document.addEventListener('click', (e) => {
      if (e.target.closest('.delete-transaction-button')) {
        const button = e.target.closest('.delete-transaction-button');
        const recordId = button.getAttribute('data-id');
        
        // 确认删除
        if (confirm('Are you sure you want to delete this transaction record? This action cannot be undone.')) {
          showLoading();
          
          // 检查用户权限
          if (userRole !== 'sadmin') {
            alert('You do not have permission to delete transaction records.');
            hideLoading();
            return;
          }
          
          // 删除记录
          db.ref(`transactions/${recordId}`).remove()
            .then(() => {
              // 从DOM中移除元素
              const row = button.closest('tr');
              if (row) row.remove();
              
              const card = document.querySelector(`.transaction-card .delete-transaction-button[data-id="${recordId}"]`);
              if (card) card.closest('.transaction-card').remove();
              
              alert('Transaction record deleted successfully.');
            })
            .catch((error) => {
              console.error('Delete Error:', error);
              alert('Failed to delete transaction record: ' + error.message);
            })
            .finally(() => {
              hideLoading();
            });
        }
      }
    });

    // 1. 添加 Firebase Presence System
    function initializePresenceSystem() {
      // Get a reference to the user's status node
      const user = auth.currentUser;
      if (!user) return;

      const userStatusRef = db.ref(`onlineRecords/${user.uid}`);
      
      // Create a reference to the special '.info/connected' path in Firebase
      const connectionRef = db.ref('.info/connected');
      
      connectionRef.on('value', (snapshot) => {
        // If we're not currently connected, don't do anything.
        if (!snapshot.val()) return;

        // If we are currently connected, then use the onDisconnect()
        // method to add a handler that will cancel our online status
        // when we disconnect.
        userStatusRef.onDisconnect().update({
          isOnline: false,
          lastActive: new Date().toISOString()
        }).then(() => {
          // Set the status to online now
          userStatusRef.update({
            isOnline: true,
            lastActive: new Date().toISOString()
          });
        });
      });

      // Add activity tracking
      let activityTimeout;
      const INACTIVE_TIMEOUT = 15 * 60 * 1000; // 15 minutes

      function updateUserActivity() {
        clearTimeout(activityTimeout);
        
        // Update last active time
        userStatusRef.update({
          lastActive: new Date().toISOString()
        });

        // Set timeout for inactivity
        activityTimeout = setTimeout(() => {
          userStatusRef.update({
            isOnline: false
          });
        }, INACTIVE_TIMEOUT);
      }

      // Track user activity
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(
        eventName => document.addEventListener(eventName, updateUserActivity, true)
      );

      // Initial activity state
      updateUserActivity();
    }

    // 2. 更新 auth.onAuthStateChanged 处理程序
    auth.onAuthStateChanged((user) => {
      if (user) {
        // User is logged in
        authContainer.style.display = 'none';
        appContainer.style.display = 'block';
        document.body.classList.add('logged-in');
        getUserRole(user.uid);

        // Initialize presence system
        initializePresenceSystem();

        // Display welcome message
        const displayName = user.displayName || 'User';
        welcomeMessage.textContent = `Welcome, ${displayName} (${userRole ? userRole : 'Loading...'})`;
      } else {
        // User is not logged in
        authContainer.style.display = 'block';
        appContainer.style.display = 'none';
        document.body.classList.remove('logged-in');
        inventoryTableBody.innerHTML = '';
        inventoryCardsContainer.innerHTML = '';
        inventoryMessage.textContent = '';
        transactionRecordsTableBody.innerHTML = '';
        transactionRecordsMessage.textContent = '';
        welcomeMessage.textContent = '';
      }
    });

    // 3. 更新 loadOnlineRecords 函数以实时更新
    function loadOnlineRecords() {
      showLoading();
      
      const user = auth.currentUser;
      if (!user) {
        hideLoading();
        return;
      }

      db.ref(`users/${user.uid}/role`).once('value')
        .then(snapshot => {
          const role = snapshot.val();
          if (role !== 'sadmin') {
            console.error('Unauthorized access to online records');
            hideLoading();
            return;
          }

          // Use .on() instead of .once() for real-time updates
          db.ref('onlineRecords').on('value', snapshot => {
            const data = snapshot.val();
            const onlineRecordsTableBody = document.getElementById('online-records-table-body');
            onlineRecordsTableBody.innerHTML = '';

            if (data) {
              // Add auto-cleanup for old records (older than 24 hours)
              const cutoff = new Date();
              cutoff.setHours(cutoff.getHours() - 24);

              Object.entries(data).forEach(([userId, record]) => {
                const lastActive = new Date(record.lastActive);
                
                // Skip or remove old records
                if (lastActive < cutoff) {
                  db.ref(`onlineRecords/${userId}`).remove();
                  return;
                }

                const tr = document.createElement('tr');
                const onlineStatus = record.isOnline ? 
                  '<span style="color: green;">Online</span>' : 
                  '<span style="color: red;">Offline</span>';

                // Calculate time since last active
                const timeSinceLastActive = formatTimeSince(lastActive);

                tr.innerHTML = `
                  <td>${record.userName || 'Unknown'}</td>
                  <td>${record.email || 'N/A'}</td>
                  <td>${formatDateTime(record.loginTime)}</td>
                  <td>${formatDateTime(record.lastActive)} (${timeSinceLastActive})</td>
                  <td>${onlineStatus}</td>
                `;
                onlineRecordsTableBody.appendChild(tr);
              });
            } else {
              onlineRecordsTableBody.innerHTML = '<tr><td colspan="5">No online records found.</td></tr>';
            }
          });
        })
        .catch(error => {
          console.error('Failed to load online records:', error);
        })
        .finally(() => {
          hideLoading();
        });
    }

    // 4. 添加辅助函数来格式化时间差
    function formatTimeSince(date) {
      const seconds = Math.floor((new Date() - date) / 1000);

      let interval = seconds / 31536000;
      if (interval > 1) return Math.floor(interval) + ' years ago';
      
      interval = seconds / 2592000;
      if (interval > 1) return Math.floor(interval) + ' months ago';
      
      interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + ' days ago';
      
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + ' hours ago';
      
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + ' minutes ago';
      
      return Math.floor(seconds) + ' seconds ago';
    }

    // 初始化 Firebase
    const versionRef = firebase.database().ref('version');

    // 添加防抖动函数
    let updateTimeout = null;
    function debounceUpdate(fn, delay) {
        if (updateTimeout) {
            clearTimeout(updateTimeout);
        }
        updateTimeout = setTimeout(fn, delay);
    }

    function checkForUpdates() {
        versionRef.once('value').then((snapshot) => {
            const newVersion = snapshot.val();
            const currentVersion = localStorage.getItem('appVersion');
            
            if (currentVersion && currentVersion !== newVersion) {
                localStorage.setItem('appVersion', newVersion);
                // 自定义提示消息
                if (confirm('System have update ' + newVersion + '\nclick OK to update')) {
                    window.location.reload();
                }
            } else if (!currentVersion) {
                localStorage.setItem('appVersion', newVersion);
            }
        });
    }

    // 启动检查
    checkForUpdates();

    // 更频繁地检查更新（每30秒检查一次）
    setInterval(checkForUpdates, 1000 * 30); // 改为30秒

    // 添加图片查看模态框
    document.getElementById('image-view-modal').addEventListener('click', function() {
      const imageUrl = this.querySelector('.image-modal-content').src;
      document.getElementById('full-size-image').src = imageUrl;
      document.getElementById('image-view-modal').style.display = 'block';
    });

    // 在现有的 JavaScript 代码中添加以下内容

    // 图片上传功能
    document.getElementById('upload-image-button').addEventListener('click', async () => {
        const fileInput = document.getElementById('edit-item-image');
        const file = fileInput.files[0];
        const errorElement = document.getElementById('image-upload-error');
        
        if (!file) {
            errorElement.textContent = 'Please select an image file';
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            errorElement.textContent = 'Please select a valid image file';
            return;
        }
        
        showLoading();
        
        try {
            const formData = new FormData();
            formData.append('image', file);
            
            const response = await fetch('https://api.imgbb.com/1/upload?key=51cc976f3a3ccae11ea917f2d7d9a9ff', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                const imageUrl = data.data.url;
                const previewContainer = document.getElementById('image-preview-container');
                previewContainer.innerHTML = `
                    <img src="${imageUrl}" alt="Product image">
                    <button class="delete-image-button" onclick="deleteProductImage('${imageUrl}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                previewContainer.setAttribute('data-image-url', imageUrl);
                errorElement.textContent = '';

                // 直接更新数据库中的图片URL，不包含修改记录
                if (currentEditItemId) {
                    const location = document.getElementById('edit-item-location').value;
                    const inventoryPath = `inventory/${location}`;
                    const itemRef = db.ref(`${inventoryPath}/${currentEditItemId}`);
                    
                    await itemRef.update({
                        imageUrl: imageUrl
                    });
                }
            } else {
                errorElement.textContent = 'Failed to upload image';
            }
        } catch (error) {
            console.error('Upload Error:', error);
            errorElement.textContent = 'Failed to upload image: ' + error.message;
        } finally {
            hideLoading();
        }
    });

    // 删除产品图片
    function deleteProductImage(imageUrl) {
        if (confirm('Are you sure you want to delete this product image?')) {
            const user = auth.currentUser;
            if (user && currentEditItemId) {
                const location = document.getElementById('edit-item-location').value;
                const inventoryPath = `inventory/${location}`;
                const itemRef = db.ref(`${inventoryPath}/${currentEditItemId}`);
                
                showLoading();
                itemRef.update({
                    imageUrl: null
                })
                .then(() => {
                    // 清除预览
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = '';
                    previewContainer.removeAttribute('data-image-url');
                    
                    // 刷新库存显示
                    loadInventoryForRole();
                })
                .catch((error) => {
                    console.error('Failed to delete image:', error);
                    alert('Failed to delete image: ' + error.message);
                })
                .finally(() => {
                    hideLoading();
                });
            }
        }
    }

    // 修改保存编辑的函数
    saveEditButton.addEventListener('click', () => {
        const name = document.getElementById('edit-item-name').value.trim();
        const category = document.getElementById('edit-item-category').value;
        const quantity = document.getElementById('edit-item-quantity').value;
        const unit = document.getElementById('edit-item-unit').value.trim();
        const expiredDate = document.getElementById('edit-item-expired-date').value.trim();
        const location = document.getElementById('edit-item-location').value;
        const imageUrl = document.getElementById('image-preview-container').getAttribute('data-image-url');
        
        // Basic validation
        if (!name || !category || !quantity || !unit || !location) {
            document.getElementById('edit-item-error').textContent = 'Please fill in all required fields.';
            return;
        }

        // Validate expiry date format if provided
        if (expiredDate && !/^\d{2}-\d{2}-\d{4}$/.test(expiredDate)) {
            document.getElementById('edit-item-error').textContent = 'Invalid date format. Please use DD-MM-YYYY';
            return;
        }

        const user = auth.currentUser;
        if (!user) {
            document.getElementById('edit-item-error').textContent = 'User not authenticated.';
            return;
        }

        showLoading();

        // Get the correct inventory path based on location
        const inventoryPath = `inventory/${location}`;
        const itemRef = db.ref(`${inventoryPath}/${currentEditItemId}`);

        // 获取当前项目的数据
        itemRef.once('value')
            .then((snapshot) => {
                const currentData = snapshot.val();
                
                // 准备更新数据
                const updateData = {
                    name,
                    category,
                    quantity: Number(quantity),
                    unit,
                    expiredDate: expiredDate || null,
                    location
                };

                // 只有在其他字段（非图片）发生变化时才更新修改时间和修改人
                if (name !== currentData.name ||
                    category !== currentData.category ||
                    Number(quantity) !== currentData.quantity ||
                    unit !== currentData.unit ||
                    expiredDate !== currentData.expiredDate ||
                    location !== currentData.location) {
                    
                    updateData.modifiedTime = new Date().toISOString();
                    updateData.modifiedBy = user.displayName || 'Unknown';
                }

                // 保持现有的图片URL
                if (imageUrl) {
                    updateData.imageUrl = imageUrl;
                }

                // 更新数据
                return itemRef.update(updateData);
            })
            .then(() => {
                // Close modal and refresh inventory
                document.getElementById('edit-modal').style.display = 'none';
                loadInventoryForRole();
            })
            .catch((error) => {
                console.error('Edit Error:', error);
                document.getElementById('edit-item-error').textContent = 'Failed to save changes: ' + error.message;
            })
            .finally(() => {
                hideLoading();
            });
    });

    // 修改打开编辑模态框的函数
    function openEditModal(itemId, type, name, category, quantity, unit, expiredDate, location, imageUrl) {
        currentEditItemId = itemId;
        document.getElementById('edit-item-name').value = name;
        document.getElementById('edit-item-category').value = category;
        document.getElementById('edit-item-quantity').value = quantity;
        document.getElementById('edit-item-unit').value = unit;
        document.getElementById('edit-item-expired-date').value = expiredDate || '';
        document.getElementById('edit-item-location').value = location;
        document.getElementById('edit-item-error').textContent = '';
        
        // 显示图片预览（如果有）
        const previewContainer = document.getElementById('image-preview-container');
        if (imageUrl) {
            previewContainer.innerHTML = `
                <div style="position: relative;">
                    <img src="${imageUrl}" alt="Product image" style="max-width: 100%; height: auto;">
                    <button class="delete-image-button" onclick="deleteProductImage('${imageUrl}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            previewContainer.setAttribute('data-image-url', imageUrl);
        } else {
            previewContainer.innerHTML = '';
            previewContainer.removeAttribute('data-image-url');
        }
        
        // 根据用户角色显示/隐藏图片上传部分
        const imageUploadSection = document.getElementById('image-upload-section');
        imageUploadSection.style.display = userRole === 'sadmin' ? 'block' : 'none';
        
        document.getElementById('edit-modal').style.display = 'block';
    }

    // 修改创建表格行的函数
    function createTableRow(item) {
        const tr = document.createElement('tr');
        tr.style.height = '32px';
        
        // Format the expiry date if it exists
        const formattedExpiryDate = item.expiredDate || 'N/A';
        
        tr.innerHTML = `
            <td style="padding: 4px 8px;">${item.name}</td>
            <td style="padding: 4px 8px; text-align: center;">
                ${item.imageUrl ? `
                    <img src="${item.imageUrl}" alt="Product" class="inventory-image" onclick="showFullImage('${item.imageUrl}')">
                ` : ''}
            </td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${item.category || 'N/A'}</td>
            <td style="padding: 4px 8px;">${item.quantity}</td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${item.unit}</td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${formattedExpiryDate}</td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${item.location}</td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${formatDateTime(item.modifiedTime)}</td>
            <td class="hide-on-mobile" style="padding: 4px 8px;">${item.modifiedBy}</td>
            <td style="padding: 4px 8px;">
                <div style="display: flex; gap: 4px; justify-content: flex-start;">
                    <button class="edit-button" data-item-id="${item.id}" style="padding: 2px 8px; margin: 0;">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="delete-button" data-item-id="${item.id}" data-item-name="${item.name}" style="padding: 2px 8px; margin: 0;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        return tr;
    }

    // 添加图片查看功能
    function showFullImage(imageUrl) {
        const modal = document.getElementById('image-view-modal');
        const modalImg = document.getElementById('full-size-image');
        modalImg.src = imageUrl;
        modal.style.display = 'block';
    }

    // 关闭图片查看模态框
    document.querySelector('#image-view-modal .close').onclick = function() {
        document.getElementById('image-view-modal').style.display = "none";
    }

    // 添加这些新的事件监听器
    document.addEventListener('DOMContentLoaded', function() {
        const imageModal = document.getElementById('image-view-modal');
        const closeButton = imageModal.querySelector('.close');
        
        // 点击关闭按钮关闭模态框
        closeButton.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡
            imageModal.style.display = 'none';
        });
        
        // 点击模态框背景关闭模态框
        imageModal.addEventListener('click', function(e) {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        });
        
        // 阻止点击图片时关闭模态框
        document.getElementById('full-size-image').addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // 确保搜索和分类过滤器的事件监听器正确设置
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const categoryFilter = document.getElementById('inventory-category-filter');
        
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            filterInventory(query, category);
        });
        
        categoryFilter.addEventListener('change', () => {
            const query = searchInput.value.toLowerCase();
            const category = categoryFilter.value;
            filterInventory(query, category);
        });
    });
  </script>
</body>
</html>
